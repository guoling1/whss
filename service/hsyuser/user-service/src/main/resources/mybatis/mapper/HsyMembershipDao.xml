<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hsy.user.dao.HsyMembershipDao">
    <insert id="insertMembershipCard" useGeneratedKeys="true" keyProperty="id" parameterType="com.jkm.hsy.user.entity.AppPolicyMembershipCard">
        insert into app_policy_membership_card(UID,MEMBERSHIPNAME,MEMBERSHIPSHOPNAME,DISCOUNT,ISDEPOSITED,DEPOSITAMOUNT,ISPRESENTEDVIAACTIVATE,PRESENTAMOUNT,CANRECHARGE,ISPRESENTEDVIARECHARGE,RECHARGELIMITAMOUNT,RECHARGEPRESENTAMOUNT,WEIGHT,STATUS,CREATETIME,UPDATETIME)
        values(#{uid},#{membershipName},#{membershipShopName},#{discount},#{isDeposited},#{depositAmount},#{isPresentedViaActivate},#{presentAmount},#{canRecharge},#{isPresentedViaRecharge},#{rechargeLimitAmount},#{rechargePresentAmount},#{weight},#{status},#{createTime},#{updateTime})
    </insert>

    <update id="updateMembershipCard" parameterType="com.jkm.hsy.user.entity.AppPolicyMembershipCard">
        update app_policy_membership_card
        <set>
            <if test="uid!=null">UID=#{uid},</if>
            <if test="membershipName!=null and membershipName!=''">MEMBERSHIPNAME=#{membershipName},</if>
            <if test="membershipShopName!=null and membershipShopName!=''">MEMBERSHIPSHOPNAME=#{membershipShopName},</if>
            <if test="discount!=null">DISCOUNT=#{discount},</if>
            <if test="isDeposited!=null">ISDEPOSITED=#{isDeposited},</if>
            <if test="depositAmount!=null">DEPOSITAMOUNT=#{depositAmount},</if>
            <if test="isPresentedViaActivate!=null">ISPRESENTEDVIAACTIVATE=#{isPresentedViaActivate},</if>
            <if test="presentAmount!=null">PRESENTAMOUNT=#{presentAmount},</if>
            <if test="canRecharge!=null">CANRECHARGE=#{canRecharge},</if>
            <if test="isPresentedViaRecharge!=null">ISPRESENTEDVIARECHARGE=#{isPresentedViaRecharge},</if>
            <if test="rechargeLimitAmount!=null">RECHARGELIMITAMOUNT=#{rechargeLimitAmount},</if>
            <if test="rechargePresentAmount!=null">RECHARGEPRESENTAMOUNT=#{rechargePresentAmount},</if>
            <if test="weight!=null">WEIGHT=#{weight},</if>
            <if test="status!=null">STATUS=#{status},</if>
            <if test="createTime!=null">CREATETIME=#{createTime},</if>
            <if test="updateTime!=null">UPDATETIME=#{updateTime}</if>
        </set> where ID=#{id}
    </update>

    <insert id="insertMembershipCardShop" useGeneratedKeys="true" keyProperty="uuid" parameterType="com.jkm.hsy.user.entity.AppPolicyMembershipCardShop">
        insert into app_policy_membership_card_shop(MCID,SID)
        values(#{mcid},#{sid})
    </insert>

    <insert id ="insertMembershipCardShopBatch" parameterType="java.util.List" >
        insert into app_policy_membership_card_shop
        (MCID,SID)
        values
        <foreach collection ="list" item="data" index= "index" separator =",">
            (
              #{data.mcid},#{data.sid}
            )
        </foreach >
    </insert>

    <delete id="deleteMembershipCardShop">
        delete from app_policy_membership_card_shop where MCID=#{mcid}
    </delete>

    <select id="findConsumerByParam" resultType="com.jkm.hsy.user.entity.AppPolicyConsumer">
        select ID,CONSUMERCELLPHONE,USERID,OPENID,PAYPASSWORD,CREATETIME,UPDATETIME
        from app_policy_consumer
        where 1=1
        <if test="userID!=null and userID!=''">and USERID=#{userID}</if>
        <if test="openID!=null and openID!=''">and OPENID=#{openID}</if>
        <if test="consumerCellphone!=null and consumerCellphone!=''">and CONSUMERCELLPHONE=#{consumerCellphone}</if>
    </select>

    <select id="findMemberByParam" resultType="com.jkm.hsy.user.entity.AppPolicyMember">
        select ID,CID,MCID,ACCOUNTID,RECEIPTACCOUNTID,MEMBERCARDNO,STATUS,CREATETIME,UPDATETIME
        from app_policy_member
        where status=1
        <if test="cid!=null and cid!=''">and CID=#{cid}</if>
        <if test="mcid!=null and mcid!=''">and MCID=#{mcid}</if>
    </select>

    <select id="findMemberCascadeByParam" resultType="com.jkm.hsy.user.entity.AppPolicyMember">
        select member.ID,member.CID,member.MCID,member.ACCOUNTID,member.RECEIPTACCOUNTID,member.MEMBERCARDNO,member.STATUS,member.CREATETIME,member.UPDATETIME,
        card.MEMBERSHIPNAME,card.MEMBERSHIPSHOPNAME,card.DISCOUNT,card.ISDEPOSITED,card.UID,card.DEPOSITAMOUNT,card.ISPRESENTEDVIAACTIVATE,card.PRESENTAMOUNT,card.CANRECHARGE,card.ISPRESENTEDVIARECHARGE,card.RECHARGELIMITAMOUNT,card.RECHARGEPRESENTAMOUNT
        from app_policy_member member left join app_policy_membership_card card on member.MCID=card.ID
        where member.status!=3 and card.status=1
        <if test="cid!=null and cid!=''">and member.CID=#{cid}</if>
        <if test="uid!=null and uid!=''">and card.UID=#{uid}</if>
        order by CREATETIME desc
    </select>

    <select id="findMemberCardByParam" resultType="com.jkm.hsy.user.entity.AppPolicyMembershipCard">
        select ID,UID,MEMBERSHIPNAME,MEMBERSHIPSHOPNAME,DISCOUNT,ISDEPOSITED,DEPOSITAMOUNT,ISPRESENTEDVIAACTIVATE,PRESENTAMOUNT,ISPRESENTEDVIARECHARGE,RECHARGELIMITAMOUNT,RECHARGEPRESENTAMOUNT,WEIGHT,STATUS,CREATETIME,UPDATETIME
        from app_policy_membership_card
        where status=1
        <if test="uid!=null and uid!=''">and UID=#{uid}</if>
    </select>

    <insert id="insertConsumer" useGeneratedKeys="true" keyProperty="id" parameterType="com.jkm.hsy.user.entity.AppPolicyConsumer">
        insert into app_policy_consumer(ID,CONSUMERCELLPHONE,USERID,OPENID,PAYPASSWORD,CREATETIME,UPDATETIME)
        values(#{id},#{consumerCellphone},#{userID},#{openID},#{payPassword},#{createTime},#{updateTime})
    </insert>

    <update id="updateConsumer" parameterType="com.jkm.hsy.user.entity.AppPolicyConsumer">
        update app_policy_consumer
        <set>
            <if test="consumerCellphone!=null and consumerCellphone!=''">CONSUMERCELLPHONE=#{consumerCellphone},</if>
            <if test="userID!=null and userID!=''">USERID=#{userID},</if>
            <if test="openID!=null and openID!=''">OPENID=#{openID},</if>
            <if test="payPassword!=null and payPassword!=''">PAYPASSWORD=#{payPassword},</if>
            <if test="createTime!=null">CREATETIME=#{createTime},</if>
            <if test="updateTime!=null">UPDATETIME=#{updateTime}</if>
        </set> where ID=#{id}
    </update>

    <insert id="insertMember" useGeneratedKeys="true" keyProperty="id" parameterType="com.jkm.hsy.user.entity.AppPolicyMember">
        insert into app_policy_member(ID,CID,MCID,ACCOUNTID,RECEIPTACCOUNTID,MEMBERCARDNO,STATUS,CREATETIME,UPDATETIME)
        values(#{id},#{cid},#{mcid},#{accountID},#{receiptAccountID},#{memberCardNO},#{status},#{createTime},#{updateTime})
    </insert>

    <update id="updateMember" parameterType="com.jkm.hsy.user.entity.AppPolicyMember">
        update app_policy_member
        <set>
            <if test="cid!=null">CID=#{cid},</if>
            <if test="mcid!=null">MCID=#{mcid},</if>
            <if test="accountID!=null">ACCOUNTID=#{accountID},</if>
            <if test="receiptAccountID!=null">RECEIPTACCOUNTID=#{receiptAccountID},</if>
            <if test="memberCardNO!=null and memberCardNO!=''">MEMBERCARDNO=#{memberCardNO},</if>
            <if test="status!=null">STATUS=#{status},</if>
            <if test="createTime!=null">CREATETIME=#{createTime},</if>
            <if test="updateTime!=null">UPDATETIME=#{updateTime}</if>
        </set> where ID=#{id}
    </update>

    <select id="findMemberInfoByID" resultType="com.jkm.hsy.user.entity.AppPolicyMember">
        select distinct member.ID,member.CID,member.MCID,member.ACCOUNTID,member.RECEIPTACCOUNTID,member.MEMBERCARDNO,member.STATUS,member.CREATETIME,member.UPDATETIME,consumer.CONSUMERCELLPHONE,consumer.USERID,consumer.OPENID,
        card.MEMBERSHIPNAME,card.MEMBERSHIPSHOPNAME,card.DISCOUNT,card.ISDEPOSITED,card.UID,card.DEPOSITAMOUNT,card.ISPRESENTEDVIAACTIVATE,card.PRESENTAMOUNT,card.CANRECHARGE,card.ISPRESENTEDVIARECHARGE,card.RECHARGELIMITAMOUNT,card.RECHARGEPRESENTAMOUNT
        from app_policy_member member
        left join app_policy_consumer consumer on member.CID=consumer.ID
        left join app_policy_membership_card card on member.MCID=card.ID
        where member.ID=${id}
    </select>

    <select id="findMembershipCardCountOfUserByUID" resultType="java.lang.Integer">
        select count(*) from app_policy_membership_card where UID=#{uid}
    </select>

    <select id="findMemberCardList" resultType="com.jkm.hsy.user.entity.AppPolicyMembershipCard">
        select ID,UID,MEMBERSHIPNAME,MEMBERSHIPSHOPNAME,DISCOUNT,ISDEPOSITED,DEPOSITAMOUNT,ISPRESENTEDVIAACTIVATE,PRESENTAMOUNT,CANRECHARGE,ISPRESENTEDVIARECHARGE,RECHARGELIMITAMOUNT,RECHARGEPRESENTAMOUNT,WEIGHT,STATUS,CREATETIME,UPDATETIME,
        (select count(*) from app_policy_member member where mcid=card.ID and status=1) memberCount,
        (select COALESCE(sum(TRADEAMOUNT),0) from app_policy_recharge_order where mcid=card.ID and status=1) rechargeSum,
        (select COALESCE(sum(amount),0) from tb_hsy_order where mcid=card.ID and orderstatus!=1 and orderstatus!=3 and orderstatus!=8) consumeSum
        from app_policy_membership_card card where UID=#{uid}
    </select>

    <select id="findMemberCountOfUserByUID" resultType="java.lang.Integer">
        select count(*) from app_policy_member member left join app_policy_membership_card card on card.ID=member.MCID
        where card.UID=#{uid}
    </select>

    <select id="findShopNameAndGlobalID" resultType="com.jkm.hsy.user.entity.AppAuUser">
        select user.GLOBALID globalID,shop.name shopName,user.accountID accountID
        from app_au_user user left join app_biz_shop_user_role sur on user.ID=sur.UID
        left join app_biz_shop shop on shop.ID=sur.sid
        where sur.TYPE=1 and user.ID=#{uid}
    </select>

    <insert id="insertRechargeOrder" useGeneratedKeys="true" keyProperty="id" parameterType="com.jkm.hsy.user.entity.AppPolicyRechargeOrder">
        insert into app_policy_recharge_order(ORDERNO,TRADENO,TRADEID,TRADEAMOUNT,REALPAYAMOUNT,MARKETINGAMOUNT,PAYEEACCOUNTID,OUID,MEMBERID,MEMBERACCOUNTID,CID,MCID,UID,MERCHANTRECEIVEACCOUNTID,MEMBERSHIPNAME,CONSUMERCELLPHONE,GOODSNAME,GOODSDESCRIBE,MERCHANTNAME,MERCHANTNO,PAYSN,PAYCHANNELSIGN,PAYSUCCESSTIME,STATUS,TYPE,SOURCE,POUNDAGE,REMARK,SETTLETYPE,CREATETIME,UPDATETIME)
        values(#{orderNO},#{tradeNO},#{tradeID},#{tradeAmount},#{realPayAmount},#{marketingAmount},#{payeeAccountID},#{ouid},#{memberID},#{memberAccountID},#{cid},#{mcid},#{uid},#{merchantReceiveAccountID},#{membershipName},#{consumerCellphone},#{goodsName},#{goodsDescribe},#{merchantName},#{merchantNO},#{paySN},#{payChannelSign},#{paySuccessTime},#{status},#{type},#{source},#{poundage},#{remark},#{settleType},#{createTime},#{updateTime})
    </insert>

    <update id="updateRechargeOrder" parameterType="com.jkm.hsy.user.entity.AppPolicyRechargeOrder">
        update app_policy_recharge_order
        <set>
            <if test="orderNO!=null and orderNO!=''">ORDERNO=#{orderNO},</if>
            <if test="tradeNO!=null and tradeNO!=''">TRADENO=#{tradeNO},</if>
            <if test="tradeID!=null">TRADEID=#{tradeID},</if>
            <if test="tradeAmount!=null">TRADEAMOUNT=#{tradeAmount},</if>
            <if test="realPayAmount!=null">REALPAYAMOUNT=#{realPayAmount},</if>
            <if test="marketingAmount!=null">MARKETINGAMOUNT=#{marketingAmount},</if>
            <if test="payeeAccountID!=null">PAYEEACCOUNTID=#{payeeAccountID},</if>
            <if test="ouid!=null">OUID=#{ouid},</if>
            <if test="memberID!=null">MEMBERID=#{memberID},</if>
            <if test="memberAccountID!=null">MEMBERACCOUNTID=#{memberAccountID},</if>
            <if test="cid!=null">CID=#{cid},</if>
            <if test="mcid!=null">MCID=#{mcid},</if>
            <if test="uid!=null">UID=#{uid},</if>
            <if test="merchantReceiveAccountID!=null">MERCHANTRECEIVEACCOUNTID=#{merchantReceiveAccountID},</if>
            <if test="membershipName!=null and membershipName!=''">MEMBERSHIPNAME=#{membershipName},</if>
            <if test="consumerCellphone!=null and consumerCellphone!=''">CONSUMERCELLPHONE=#{consumerCellphone},</if>
            <if test="goodsName!=null and goodsName!=''">GOODSNAME=#{goodsName},</if>
            <if test="goodsDescribe!=null and goodsDescribe!=''">GOODSDESCRIBE=#{goodsDescribe},</if>
            <if test="merchantName!=null and merchantName!=''">MERCHANTNAME=#{merchantName},</if>
            <if test="merchantNO!=null and merchantNO!=''">MERCHANTNO=#{merchantNO},</if>
            <if test="paySN!=null and paySN!=''">PAYSN=#{paySN},</if>
            <if test="payChannelSign!=null">PAYCHANNELSIGN=#{payChannelSign},</if>
            <if test="paySuccessTime!=null">PAYSUCCESSTIME=#{paySuccessTime},</if>
            <if test="status!=null">STATUS=#{status},</if>
            <if test="type!=null">TYPE=#{type},</if>
            <if test="source!=null">SOURCE=#{source},</if>
            <if test="poundage!=null">POUNDAGE=#{poundage},</if>
            <if test="remark!=null">REMARK=#{remark},</if>
            <if test="settleType!=null">SETTLETYPE=#{settleType},</if>
            <if test="createTime!=null">CREATETIME=#{createTime},</if>
            <if test="updateTime!=null">UPDATETIME=#{updateTime}</if>
        </set> where ID=#{id}
    </update>

    <select id="findMemberCardByID" resultType="com.jkm.hsy.user.entity.AppPolicyMembershipCard">
        select ID,UID,MEMBERSHIPNAME,MEMBERSHIPSHOPNAME,DISCOUNT,ISDEPOSITED,DEPOSITAMOUNT,ISPRESENTEDVIAACTIVATE,PRESENTAMOUNT,CANRECHARGE,ISPRESENTEDVIARECHARGE,RECHARGELIMITAMOUNT,RECHARGEPRESENTAMOUNT,WEIGHT,STATUS,CREATETIME,UPDATETIME
        from app_policy_membership_card
        where status=1 and ID=#{id}
    </select>

    <select id="findMemberCardCountByMCID" resultType="java.lang.Integer">
      select count(1) from app_policy_member where mcid=#{mcid} and status=1
    </select>

    <select id="findMemberCardCascadeCountByUID" resultType="java.lang.Integer">
        select count(1) from app_policy_member member
        left join app_policy_membership_card card on member.mcid=card.id
        where card.UID=#{uid} and member.status=1
        <if test="startTime!=null">
            AND member.CREATETIME >=#{startTime}
        </if>
        <if test="endTime!=null">
            <![CDATA[AND member.CREATETIME <=#{endTime}]]>
        </if>
    </select>

    <select id="findChannelAccountID" resultType="com.jkm.hsy.user.entity.BasicChannel">
        select id,account_id accountid,channel_type_sign channelTypeSign from tb_basic_channel
        where channel_type_sign=#{channelTypeSign}
    </select>

    <select id="findSuitShopByMCID" resultType="com.jkm.hsy.user.entity.AppBizShop">
        select shop.ID,shop.NAME,shop.SHORTNAME,shop.ADDRESS,shop.CONTACTCELLPHONE from app_biz_shop shop
        left join app_policy_membership_card_shop mcs on mcs.sid=shop.id
        where mcs.MCID=${mcid}
    </select>

    <select id="findMemberListByPage" parameterType="page" resultType="com.jkm.hsy.user.entity.AppPolicyMember">
        select distinct member.ID,member.CID,member.MCID,member.ACCOUNTID,member.RECEIPTACCOUNTID,member.MEMBERCARDNO,member.STATUS,member.CREATETIME,member.UPDATETIME,consumer.CONSUMERCELLPHONE,
        card.MEMBERSHIPNAME,card.MEMBERSHIPSHOPNAME
        from app_policy_member member
        left join app_policy_consumer consumer on member.CID=consumer.ID
        left join app_policy_membership_card card on member.MCID=card.ID
        where card.UID=#{objectT.uid} and member.status=1
        <if test="objectT.param!=null and objectT.param!=''">
            AND (consumer.CONSUMERCELLPHONE LIKE CONCAT('%',#{objectT.param},'%') or card.MEMBERSHIPNAME LIKE CONCAT('%',#{objectT.param},'%'))
        </if>
        <if test="objectT.mcid!=null">
            AND mcid=#{objectT.mcid}
        </if>
        order by member.UPDATETIME desc
    </select>

    <select id="findMemberListByPageCount" parameterType="com.jkm.hsy.user.entity.AppPolicyMember" resultType="java.lang.Integer">
        select count(1) from (select distinct
        member.ID,member.CID,member.MCID,member.ACCOUNTID,member.RECEIPTACCOUNTID,member.MEMBERCARDNO,member.STATUS,member.CREATETIME,member.UPDATETIME,consumer.CONSUMERCELLPHONE,
        card.MEMBERSHIPNAME,card.MEMBERSHIPSHOPNAME
        from app_policy_member member
        left join app_policy_consumer consumer on member.CID=consumer.ID
        left join app_policy_membership_card card on member.MCID=card.ID
        where card.UID=#{uid} and member.status=1
        <if test="param!=null and param!=''">
            AND (consumer.CONSUMERCELLPHONE LIKE CONCAT('%',#{param},'%') or card.MEMBERSHIPNAME LIKE CONCAT('%',#{param},'%'))
        </if>
        <if test="mcid!=null">
            AND mcid=#{mcid}
        </if>) x
    </select>

    <select id="findRechargeOrderListByPage" parameterType="page" resultType="com.jkm.hsy.user.entity.AppPolicyRechargeOrder">
        select
          rorder.ID,rorder.ORDERNO,rorder.TRADENO,rorder.TRADEAMOUNT,rorder.REALPAYAMOUNT,rorder.MARKETINGAMOUNT,rorder.TYPE,rorder.SOURCE,
        (case when rorder.TYPE=1 then '开卡充值'
        when rorder.TYPE=2 then '开卡送'
        when rorder.TYPE=3 then '充值'
        when rorder.TYPE=4 then '充值送' else '' end) TYPENAME,rorder.CREATETIME,rorder.UPDATETIME,consumer.CONSUMERCELLPHONE
        from app_policy_recharge_order rorder left join app_policy_consumer consumer on rorder.cid=consumer.id
        where status=1
        <if test="objectT.memberID!=null and objectT.memberID!=''">
            AND MEMBERID=#{objectT.memberID}
        </if>
        <if test="objectT.mcid!=null and objectT.mcid!=''">
            AND MCID=#{objectT.mcid}
        </if>
        order by rorder.CREATETIME desc
    </select>

    <select id="findRechargeOrderListByPageCount" parameterType="com.jkm.hsy.user.entity.AppPolicyRechargeOrder" resultType="java.lang.Integer">
        select count(1) from (select
        rorder.ID,rorder.ORDERNO,rorder.TRADENO,rorder.TRADEAMOUNT,rorder.REALPAYAMOUNT,rorder.MARKETINGAMOUNT,rorder.TYPE,rorder.SOURCE,rorder.CREATETIME,rorder.UPDATETIME,consumer.CONSUMERCELLPHONE
        from app_policy_recharge_order rorder left join app_policy_consumer consumer on rorder.cid=consumer.id
        where status=1
        <if test="memberID!=null and memberID!=''">
            AND MEMBERID=#{memberID}
        </if>
        <if test="mcid!=null and mcid!=''">
            AND MCID=#{mcid}
        </if>) x
    </select>

    <select id="findRechargeOrderInfo"  resultType="com.jkm.hsy.user.entity.AppPolicyRechargeOrder">
        select
          rorder.ID,rorder.ORDERNO,rorder.TRADENO,rorder.TRADEAMOUNT,rorder.REALPAYAMOUNT,rorder.MARKETINGAMOUNT,rorder.TYPE,
        (case when rorder.TYPE=1 then '开卡充值'
        when rorder.TYPE=2 then '开卡送'
        when rorder.TYPE=3 then '充值'
        when rorder.TYPE=4 then '充值送' else '' end) TYPENAME,rorder.CREATETIME,rorder.UPDATETIME,consumer.CONSUMERCELLPHONE
        from app_policy_recharge_order rorder left join app_policy_consumer consumer on rorder.cid=consumer.id
        where rorder.id=#{id}
    </select>

    <select id="findMemberConsumeStatistic" resultType="com.jkm.hsy.user.entity.AppPolicyMemberStatistic">
        select count(1) consumeCount,COALESCE(sum(amount),0) consumeSum from tb_hsy_order
        where uid=#{uid} and isMemberCardPay =1 and orderstatus!=1 and orderstatus!=3 and orderstatus!=8
        <if test="startTime!=null">
            AND pay_success_time >=#{startTime}
        </if>
        <if test="endTime!=null">
            <![CDATA[AND pay_success_time <=#{endTime}]]>
        </if>
    </select>

    <select id="findMemberCardAndStatistic" resultType="com.jkm.hsy.user.entity.AppPolicyMembershipCard">
        select ID,MEMBERSHIPNAME,MEMBERSHIPSHOPNAME,(select count(1) from app_policy_member where MCID=card.ID and status=1) memberCount
        from app_policy_membership_card card where uid=#{uid}
    </select>

    <select id="findMemberListByOUID" resultType="com.jkm.hsy.user.entity.AppPolicyMember">
        select distinct member.ID,member.CID,member.MCID,member.ACCOUNTID,member.RECEIPTACCOUNTID,member.MEMBERCARDNO,member.STATUS,member.CREATETIME,member.UPDATETIME,consumer.CONSUMERCELLPHONE,consumer.USERID,consumer.OPENID,
        card.MEMBERSHIPNAME,card.MEMBERSHIPSHOPNAME,card.DISCOUNT,card.ISDEPOSITED,card.UID,card.DEPOSITAMOUNT,card.ISPRESENTEDVIAACTIVATE,card.PRESENTAMOUNT,card.CANRECHARGE,card.ISPRESENTEDVIARECHARGE,card.RECHARGELIMITAMOUNT,card.RECHARGEPRESENTAMOUNT
        from app_policy_member member
        left join app_policy_consumer consumer on member.CID=consumer.ID
        left join app_policy_membership_card card on member.MCID=card.ID
        where 1=1 and member.status=1
        <if test="userID!=null and userID!=''">and consumer.USERID=#{userID}</if>
        <if test="openID!=null and openID!=''">and consumer.OPENID=#{openID}</if>
    </select>

    <select id="findMemberListByOUIDAndUID" resultType="com.jkm.hsy.user.entity.AppPolicyMember">
        select distinct member.ID,member.CID,member.MCID,member.ACCOUNTID,member.RECEIPTACCOUNTID,member.MEMBERCARDNO,member.STATUS,member.CREATETIME,member.UPDATETIME,consumer.CONSUMERCELLPHONE,consumer.USERID,consumer.OPENID,
        card.MEMBERSHIPNAME,card.MEMBERSHIPSHOPNAME,card.DISCOUNT,card.ISDEPOSITED,card.UID,card.DEPOSITAMOUNT,card.ISPRESENTEDVIAACTIVATE,card.PRESENTAMOUNT,card.CANRECHARGE,card.ISPRESENTEDVIARECHARGE,card.RECHARGELIMITAMOUNT,card.RECHARGEPRESENTAMOUNT
        from app_policy_member member
        left join app_policy_consumer consumer on member.CID=consumer.ID
        left join app_policy_membership_card card on member.MCID=card.ID
        where 1=1 and card.UID=#{uid}
        <if test="status!=null">and member.status=#{status}</if>
        <if test="userID!=null and userID!=''">and consumer.USERID=#{userID}</if>
        <if test="openID!=null and openID!=''">and consumer.OPENID=#{openID}</if>
    </select>

    <select id="findLastConsumeTime" resultType="java.util.Date">
        select pay_success_time from tb_hsy_order where mid=#{mid} order by pay_success_time desc limit 1
    </select>

    <select id="findAppPolicyRechargeOrderByParam" resultType="com.jkm.hsy.user.entity.AppPolicyRechargeOrder">
        select ORDERNO,MEMBERSHIPNAME,CONSUMERCELLPHONE,TRADEAMOUNT,REALPAYAMOUNT,
        (case when source='wechat' then '微信'
        when source='alipay' then '支付宝' else '' end) source,PAYSUCCESSTIME from app_policy_recharge_order
        where 1=1
        <if test="uid!=null">and UID=#{uid}</if>
        <if test="startTime!=null">and PAYSUCCESSTIME>#{startTime}</if>
        <if test="endTime!=null"><![CDATA[ and PAYSUCCESSTIME<#{endTime}]]></if>
    </select>

    <select id="findRechargeOrderAboutRechargeStatus" resultType="com.jkm.hsy.user.entity.AppPolicyRechargeOrder">
        select ID,ORDERNO,MEMBERSHIPNAME,CONSUMERCELLPHONE,TRADEAMOUNT,REALPAYAMOUNT,STATUS,PAYSUCCESSTIME from app_policy_recharge_order
        where (status=1 or status=3) and MEMBERID=#{mid} and (type=1 or type=2)
        order by PAYSUCCESSTIME
    </select>

    <select id="getMemberList" resultType="com.jkm.hsy.user.entity.MemberResponse">
        SELECT
            a.MEMBERCARDNO,
            a.CREATETIME,
            b.CONSUMERCELLPHONE,
            b.USERID,
            b.OPENID
        FROM
            app_policy_member a
        LEFT JOIN app_policy_consumer b ON a.CID = b.ID
        WHERE 1=1
        <if test="consumerCellphone!=null and consumerCellphone!=''">and b.CONSUMERCELLPHONE=#{consumerCellphone}</if>
        <if test="memberCardNO!=null and memberCardNO!=''">and a.MEMBERCARDNO=#{memberCardNO}</if>
        ORDER BY a.CREATETIME #{offset},#{pageSize}
    </select>

    <select id="getMemberListCount" resultType="java.lang.Integer">
        SELECT
          COUNT(a.ID)
        FROM
            app_policy_member a
        LEFT JOIN app_policy_consumer b ON a.CID = b.ID
        WHERE 1=1
        <if test="consumerCellphone!=null and consumerCellphone!=''">and b.CONSUMERCELLPHONE=#{consumerCellphone}</if>
        <if test="memberCardNO!=null and memberCardNO!=''">and a.MEMBERCARDNO=#{memberCardNO}</if>
    </select>

    <select id="getMemberDetails" resultType="com.jkm.hsy.user.entity.MemberResponse">
        SELECT
        a.MEMBERCARDNO,
        a.CREATETIME,
        b.CREATETIME AS createTime1,
        b.CONSUMERCELLPHONE,
        b.USERID,
        b.OPENID
        FROM
        app_policy_member a
        LEFT JOIN app_policy_consumer b ON a.CID = b.ID
        WHERE 1=1
    </select>

    <select id="getMembershipCardShop" resultType="com.jkm.hsy.user.entity.AppPolicyMembershipCardShop">
        select MCID,SID from app_policy_membership_card_shop
        where MCID=#{mcid}
    </select>

    <select id="findConsumeOrderSum" resultType="java.math.BigDecimal">
        select
          sum(corder.amount)
        from tb_hsy_order corder left join app_policy_consumer consumer on corder.cid=consumer.id
        where orderstatus!=1 and orderstatus!=3 and orderstatus!=8
        <if test="mcid!=null and mcid!=''">
            AND MCID=#{mcid}
        </if>
        <if test="mid!=null and mid!=''">
            AND MID=#{mid}
        </if>
    </select>

</mapper>