<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hsy.user.dao.HsyMerchantAuditDao">

    <!-- 根据id查商户 -->
    <select id="selectById" resultType="com.jkm.hsy.user.entity.HsyMerchantAuditResponse">
        SELECT * FROM app_biz_shop WHERE id = #{id}
    </select>
    <!-- 查询总条数 -->
    <select id="getCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM app_biz_shop where 1=1
        <if test="globalID!=null and globalID!=''">
            AND GLOBALID=#{globalID}
        </if>
        <if test="shortName!=null and shortName!=''">
            AND SHORTNAME=#{shortName}
        </if>
    </select>

    <!-- 查询商户列表 -->
    <select id="getMerchant" resultType="com.jkm.hsy.user.entity.HsyMerchantAuditResponse">
        SELECT * FROM app_biz_shop where 1=1
        <if test="globalID!=null and globalID!=''">
            AND GLOBALID=#{globalID}
        </if>
        <if test="shortName!=null and shortName!=''">
            AND SHORTNAME=#{shortName}
        </if>
        ORDER BY
            CREATETIME DESC
        LIMIT #{offset},#{pageSize}
    </select>

    <!-- 查询详情 -->
    <select id="getDetails" resultType="com.jkm.hsy.user.entity.HsyMerchantAuditResponse">
        SELECT
			b.CELLPHONE,
            c.`NAME`,
            c.SHORTNAME,
            c.INDUSTRYCODE,
            c.DISTRICTCODE,
            c.ADDRESS,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=c.LICENCEID) AS LICENCEID,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=c.STOREFRONTID) AS STOREFRONTID,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=c.COUNTERID) AS COUNTERID,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=c.INDOORID) AS INDOORID,
            c.CONTACTNAME,
            c.CONTACTCELLPHONE,
            c.ISPUBLIC,
            c.CHECKERRORINFO,
            c.CREATETIME,
            c.UPDATETIME,
            c.ISPUBLIC,
            c.`STATUS`,
            d.UID,
            d.SID,
            b.IDCARD,
			e.IDCARDNO,
            e.CARDNO,
            e.CARDACCOUNTNAME,
            e.CARDBANK,
            e.BANKADDRESS,
						e.CREATETIME,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=b.IDCARDF) AS IDCARDF,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=b.IDCARDB) AS IDCARDB,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=b.IDCARDH) AS IDCARDH
        FROM
            app_biz_shop c
        LEFT JOIN app_biz_shop_user_role d ON d.SID=c.ID
        LEFT JOIN app_au_user b ON b.ID=d.UID
        LEFT JOIN app_biz_card e ON e.SID=c.ID
        WHERE c.ID=#{id} AND d.TYPE=1
    </select>

    <!-- 根据districtCode查城市哪个区 -->
    <select id="getCode" resultType="com.jkm.hsy.user.entity.HsyMerchantAuditResponse">
        SELECT ANAME,CODE,PARENTCODE FROM app_biz_district WHERE CODE = #{districtCode}
    </select>

    <!-- 根据districtCode查城市哪个区 -->
    <select id="getCity" resultType="com.jkm.hsy.user.entity.HsyMerchantAuditResponse">
        SELECT ANAME,PARENTCODE FROM app_biz_district WHERE CODE = #{parentCode}
    </select>

    <!-- 根据Code查城市 -->
    <select id="getCityOnly" resultType="com.jkm.hsy.user.entity.HsyMerchantAuditResponse">
        SELECT ANAME FROM app_biz_district WHERE CODE = #{parentCode}
    </select>

    <!-- 更新账户id -->
    <update id="updateAccount">
        UPDATE app_au_user SET ACCOUNTID=#{accountID} WHERE ID=#{id}
    </update>

    <!-- 审核通过 -->
    <update id="updateAuditPass">
      UPDATE app_biz_shop SET STATUS=#{status} WHERE ID=#{id}
    </update>

    <!-- 审核不通过 -->
    <update id="updateAuditNotPass">
        UPDATE app_biz_shop SET STATUS=#{status},CHECKERRORINFO=#{checkErrorInfo} WHERE ID=#{id}
    </update>

    <!-- 审核不通过更改提交资料步骤 -->
    <update id="stepChange">
        UPDATE app_au_user SET AUSTEP=0 WHERE ID=#{uid}
    </update>


    <!-- 审核不通过更改提交资料步骤 -->
    <select id="getUid" resultType="java.lang.Integer">
        SELECT UID FROM app_biz_shop_user_role WHERE SID=#{id}
    </select>


    <select id="getAccId" resultType="com.jkm.hsy.user.entity.AppAuUser">
        SELECT a.* FROM app_au_user a
        LEFT JOIN tb_account b ON a.ACCOUNTID=b.id
        LEFT JOIN app_biz_shop_user_role c ON c.UID=a.ID
        WHERE c.SID=#{id}
    </select>


</mapper>