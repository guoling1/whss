<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.merchant.dao.AppAuTokenDao">

    <insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="com.jkm.hss.merchant.entity.AppAuToken">
        insert into app_au_token(ACCESSTOKEN,ENCRYPTKEY,DEVICEID,CLIENTID,DEVICENAME,APPTYPE,OSVERSION,APPCODE,APPVERSION,APPCHANNEL,ISAVOIDINGTONE,CREATETIME,UPDATETIME) values(#{accessToken},#{encryptKey},#{deviceId},#{clientId},#{deviceName},#{appType},#{osVersion},#{appCode},#{appVersion},#{appChannel},#{isAvoidingTone},#{createTime},#{updateTime})
    </insert>
    <update id="update" parameterType="com.jkm.hss.merchant.entity.AppAuToken">
        update app_au_token
        <set>
            <if test="accessToken!=null and accessToken!=''">ACCESSTOKEN=#{accessToken},</if>
            <if test="encryptKey!=null and encryptKey!=''">ENCRYPTKEY=#{encryptKey},</if>
            <if test="deviceId!=null and deviceId!=''">DEVICEID=#{deviceId},</if>
            <if test="clientId!=null and clientid!=''">CLIENTID=#{clientId},</if>
            <if test="deviceName!=null and deviceName!=''">DEVICENAME=#{deviceName},</if>
            <if test="appType!=null and appType!=''">APPTYPE=#{appType},</if>
            <if test="osVersion!=null and osVersion!=''">OSVERSION=#{osVersion},</if>
            <if test="appCode!=null and appCode!=''">APPCODE=#{appCode},</if>
            <if test="appVersion!=null and appVersion!=''">APPVERSION=#{appVersion},</if>
            <if test="appChannel!=null and appChannel!=''">APPCHANNEL=#{appChannel},</if>
            <if test="isAvoidingTone!=null">ISAVOIDINGTONE=#{isAvoidingTone},</if>
            <if test="createTime!=null">CREATETIME=#{createTime},</if>
            <if test="updateTime!=null">UPDATETIME=#{updateTime}</if>
        </set> where ID=#{id}
    </update>

    <select id="findAppAuTokenByAccessToken" parameterType="java.lang.String" resultType="com.jkm.hss.merchant.entity.AppAuToken">
        select
        ID,ACCESSTOKEN,ENCRYPTKEY,DEVICEID,CLIENTID,DEVICENAME,APPTYPE,OSVERSION,APPCODE,APPVERSION,APPCHANNEL,ISAVOIDINGTONE,CREATETIME,UPDATETIME
        from app_au_token
        where 1=1
        <if test="accessToken!=null and accessToken!=''">and ACCESSTOKEN=#{accessToken}</if>
        order by UPDATETIME desc
    </select>

    <update id="updateAppAuToken" parameterType="com.jkm.hss.merchant.entity.AppAuToken">
        update app_au_token
        <set>
            <if test="accessToken!=null and accessToken!=''">ACCESSTOKEN=#{accessToken},</if>
            <if test="encryptKey!=null and encryptKey!=''">ENCRYPTKEY=#{encryptKey},</if>
            <if test="deviceId!=null and deviceId!=''">DEVICEID=#{deviceId},</if>
            <if test="clientId!=null and clientId!=''">CLIENTID=#{clientId},</if>
            <if test="deviceName!=null and deviceName!=''">DEVICENAME=#{deviceName},</if>
            <if test="appType!=null and appType!=''">APPTYPE=#{appType},</if>
            <if test="osVersion!=null and osVersion!=''">OSVERSION=#{osVersion},</if>
            <if test="appCode!=null and appCode!=''">APPCODE=#{appCode},</if>
            <if test="appVersion!=null and appVersion!=''">APPVERSION=#{appVersion},</if>
            <if test="appChannel!=null and appChannel!=''">APPCHANNEL=#{appChannel},</if>
            <if test="isAvoidingTone!=null">ISAVOIDINGTONE=#{isAvoidingTone},</if>
            <if test="createTime!=null">CREATETIME=#{createTime},</if>
            <if test="updateTime!=null">UPDATETIME=#{updateTime}</if>
        </set> where ID=#{id}
    </update>

    <select id="findAppAuTokenByClientId" parameterType="java.lang.String" resultType="com.jkm.hss.merchant.entity.AppAuToken">
        select
        ID,ACCESSTOKEN,ENCRYPTKEY,DEVICEID,CLIENTID,DEVICENAME,APPTYPE,OSVERSION,APPCODE,APPVERSION,APPCHANNEL,ISAVOIDINGTONE,CREATETIME,UPDATETIME
        from app_au_token token left join app_hss_user_token ut on token.ID=ut.TID
        where ut.status=1
        <if test="clientId!=null and clientId!=''">and token.CLIENTID=#{clientId}</if>
        order by token.UPDATETIME desc
    </select>

    <update id="updateAppAuUserTokenStatusByTid" parameterType="String">
        update app_hss_user_token set status=2 where TID=${tid} and status=1
    </update>

    <update id="updateAppAuUserTokenStatusByTidExceptUid" parameterType="String">
        update app_hss_user_token set status=2 where TID=${tid} and uid!=#{uid} and status=1
    </update>

    <select id="findAppAuUserTokenByParam" parameterType="com.jkm.hss.merchant.entity.AppAuUserToken" resultType="com.jkm.hss.merchant.entity.AppAuUserToken">
        select UID,TID,STATUS,LOGINTIME,OUTTIME
        from app_hss_user_token
        where 1=1
        <if test="uid!=null and uid!=''">and UID=#{uid}</if>
        <if test="tid!=null and tid!=''">and TID=#{tid}</if>
    </select>
    <update id="updateAppAuUserTokenByUidAndTid" parameterType="com.jkm.hss.merchant.entity.AppAuUserToken">
        update app_hss_user_token set STATUS=#{status} ,LOGINTIME=#{loginTime},OUTTIME=#{outTime} where UID=#{uid} and TID=#{tid}
    </update>
    <insert id="insertAppAuUserToken" useGeneratedKeys="true" keyProperty="id" parameterType="com.jkm.hss.merchant.entity.AppAuUserToken">
        insert into app_hss_user_token(UID,TID,STATUS,LOGINTIME,OUTTIME) values(#{uid},#{tid},#{status},#{loginTime},#{outTime})
    </insert>
    <select id="findLoginInfoByAccessToken" resultType="com.jkm.hss.merchant.entity.AppAuUserToken">
        select
        ut.UID,ut.TID,ut.STATUS,ut.LOGINTIME,ut.OUTTIME
        from app_au_token token left join app_hss_user_token ut on token.ID=ut.TID
        where token.ACCESSTOKEN=#{accessToken} and ut.status=1
    </select>
</mapper>