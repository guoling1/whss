<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.merchant.dao.CenterLettersDao">

    <insert id="insertContent" useGeneratedKeys="true" keyProperty="id" parameterType="com.jkm.hss.merchant.entity.CenterLetters">
        INSERT INTO tb_center_letters
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="adminId != null">
                admin_id,
            </if>
            <if test="title != null">
                title,
            </if>
            <if test="content != null">
                content,
            </if>
            <if test="status != null">
                status,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="adminId!=null">
                #{adminId},
            </if>
            <if test="title!=null">
                #{title},
            </if>
            <if test="content!=null">
                #{content},
            </if>
            <if test="status!=null">
                #{status},
            </if>
        </trim>
    </insert>

    <insert id="insertImage" useGeneratedKeys="true" parameterType="java.util.List">
        <selectKey resultType="long" keyProperty="id" order="AFTER">
            SELECT
            LAST_INSERT_ID()
        </selectKey>
        insert into tb_center_image (letters_id,img_url,status)
        values
        <foreach collection="list" item="item" index="index" separator="," >
            (#{item.lettersId},#{item.imgUrl},#{item.status})
        </foreach>
    </insert>

    <!-- 修 改-->
    <update id="update" parameterType="com.jkm.hss.merchant.entity.CenterLetters">
        UPDATE tb_center_letters
        <set>
            <if test="title != null">
                title = #{title},
            </if>
            <if test="content != null">
                content = #{content},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <select id="getLettersList" parameterType="com.jkm.hss.merchant.helper.request.GetLettersListRequest" resultType="com.jkm.hss.merchant.helper.response.LettersListResponse">
        SELECT id,(select username from tb_admin_user where id=admin_id) as adminName,title,content,status
        FROM tb_center_letters
        WHERE status=0
        <if test="startTime!=null and startTime!=''">
            AND create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset},#{pageSize}
    </select>

    <select id="getImageList" resultType="com.jkm.hss.merchant.entity.CenterImage">
        SELECT id,letters_id,img_url,status,create_time,update_time
        FROM tb_center_image
        WHERE status=0 and letters_id=#{lettersId}
        ORDER BY create_time ASC
    </select>

    <select id="getLettersCount" resultType="java.lang.Long">
        SELECT count(1)
        FROM tb_center_letters
        WHERE status=0
        <if test="startTime!=null and startTime!=''">
            AND create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND create_time <![CDATA[ <= ]]> #{endTime}
        </if>
    </select>

    <update id="PlusCount" parameterType="java.lang.Long">
        UPDATE tb_center_letters
        SET download_count=download_count+1
        WHERE id = #{lettersId}
    </update>

    <delete id="deleteImage">
        DELETE from tb_center_image where letters_id=#{lettersId}
    </delete>

    <select id="selectById" resultType="com.jkm.hss.merchant.entity.CenterLetters">
        SELECT id,admin_id,title,content,status,download_count,create_time,update_time
        FROM tb_center_letters
        WHERE status=0 and id = #{lettersId}
    </select>
</mapper>