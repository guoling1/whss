<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.merchant.dao.MerchantInfoQueryDao">

    <select id="getCount" resultType="java.lang.Integer">
        SELECT
           COUNT(*)
        FROM
        tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
        1 = 1
    <if test="merchantName != null and merchantName != ''">
        AND a.merchant_name LIKE CONCAT('%',#{merchantName},'%')
    </if>

    <if test="mobile != null and mobile != ''">
        AND a.mobile LIKE CONCAT('%',#{mobile},'%')
    </if>

    <if test="status != null">
        AND a.status in (#{status},6)
    </if>

    <if test="proxyName != null and proxyName!=''">
        AND a.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
    </if>
    <if test="proxyName1 != null and proxyName1!=''">
        AND a.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
    </if>
    <if test="startTime!=null and startTime!=''">
        AND a.create_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime!=null and endTime!=''">
        AND a.create_time <![CDATA[ <= ]]> #{endTime}
    </if>

    <if test="startTime1!=null and startTime1!=''">
        AND a.authentication_time <![CDATA[ >= ]]> #{startTime1}
    </if>

    <if test="endTime1!=null and endTime1!=''">
        AND a.authentication_time <![CDATA[ <= ]]> #{endTime1}
    </if>

    <if test="startTime2!=null and startTime2!=''">
        AND a.checked_time <![CDATA[ >= ]]> #{startTime2}
    </if>
    <if test="endTime2!=null and endTime2!=''">
        AND a.checked_time <![CDATA[ <= ]]> #{endTime2}
    </if>
    <if test="markCode!=null and markCode!=''">
        AND a.mark_code LIKE CONCAT('%',#{markCode},'%')
    </if>
    </select>

    <select id="getCount1" resultType="java.lang.Integer">
        SELECT
        COUNT(*)
        FROM
        tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
        1 = 1
        <if test="merchantName != null and merchantName != ''">
            AND a.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>

        <if test="mobile != null and mobile != ''">
            AND a.mobile LIKE CONCAT('%',#{mobile},'%')
        </if>

        <if test="status != null">
            AND a.status = #{status}
        </if>

        <if test="proxyName != null and proxyName!=''">
            AND a.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <if test="proxyName1 != null and proxyName1!=''">
            AND a.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
        </if>
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>

        <if test="startTime1!=null and startTime1!=''">
            AND a.authentication_time <![CDATA[ >= ]]> #{startTime1}
        </if>

        <if test="endTime1!=null and endTime1!=''">
            AND a.authentication_time <![CDATA[ <= ]]> #{endTime1}
        </if>

        <if test="startTime2!=null and startTime2!=''">
            AND a.checked_time <![CDATA[ >= ]]> #{startTime2}
        </if>
        <if test="endTime2!=null and endTime2!=''">
            AND a.checked_time <![CDATA[ <= ]]> #{endTime2}
        </if>
        <if test="markCode!=null and markCode!=''">
            AND a.mark_code LIKE CONCAT('%',#{markCode},'%')
        </if>
    </select>

    <!--查询待审核总数-->
    <select id="getCountRecord" resultType="java.lang.Integer">
        SELECT
        COUNT(*)
        FROM
        tb_merchant_info
        WHERE 1=1
        <if test="merchantName != null and merchantName != ''">
            AND merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>

        <if test="status != null">
            AND status=#{status}
        </if>
        <if test="startTime!=null and startTime!=''">
            AND create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND create_time <![CDATA[ <= ]]> #{endTime}
        </if>

        <if test="startTime1!=null and startTime1!=''">
            AND authentication_time <![CDATA[ >= ]]> #{startTime1}
        </if>

        <if test="endTime1!=null and endTime1!=''">
            AND authentication_time <![CDATA[ <= ]]> #{endTime1}
        </if>

        <if test="startTime2!=null and startTime2!=''">
            AND checked_time <![CDATA[ >= ]]> #{startTime2}
        </if>
        <if test="endTime2!=null and endTime2!=''">
            AND checked_time <![CDATA[ <= ]]> #{endTime2}
        </if>
    </select>


    <select id="getAll"  resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT
        a.mark_code,
        a.id,
        a.source,
        a.merchant_name,
        a.mobile,
        a. STATUS,
        a.dealer_id,
        a.create_time,
        a.authentication_time,
        a.checked_time,
        (select proxy_name from tb_dealer where id=a.first_dealer_id) as proxyName,
        (select proxy_name from tb_dealer where id=a.second_dealer_id) as proxyName1
        FROM
        tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
        1 = 1
    <if test="merchantName != null and merchantName != ''">
        AND a.merchant_name LIKE CONCAT('%',#{merchantName},'%')
    </if>

    <if test="mobile != null and mobile != ''">
        AND a.mobile LIKE CONCAT('%',#{mobile},'%')
    </if>

    <if test="status != null">
        AND a.status in (#{status},6)
    </if>

    <!--<if test="status != null">-->
        <!--AND a.status = #{status}-->
    <!--</if>-->

    <if test="proxyName != null and proxyName!=''">
        AND a.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
    </if>
    <if test="proxyName1 != null and proxyName1!=''">
        AND a.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
    </if>
    <if test="startTime!=null and startTime!=''">
        AND a.create_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime!=null and endTime!=''">
        AND a.create_time <![CDATA[ <= ]]> #{endTime}
    </if>

    <if test="startTime1!=null and startTime1!=''">
        AND a.authentication_time <![CDATA[ >= ]]> #{startTime1}
    </if>

    <if test="endTime1!=null and endTime1!=''">
        AND a.authentication_time <![CDATA[ <= ]]> #{endTime1}
    </if>

    <if test="startTime2!=null and startTime2!=''">
        AND a.checked_time <![CDATA[ >= ]]> #{startTime2}
    </if>
    <if test="endTime2!=null and endTime2!=''">
        AND a.checked_time <![CDATA[ <= ]]> #{endTime2}
    </if>
    <if test="markCode!=null and markCode!=''">
        AND a.mark_code LIKE CONCAT('%',#{markCode},'%')
    </if>
        ORDER BY
        create_time DESC
        LIMIT #{offset},#{pageSize}

    </select>

    <select id="getAll1"  resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT
        a.mark_code,
        a.id,
        a.source,
        a.merchant_name,
        a.mobile,
        a. STATUS,
        a.dealer_id,
        a.create_time,
        a.authentication_time,
        a.checked_time,
        (select proxy_name from tb_dealer where id=a.first_dealer_id) as proxyName,
        (select proxy_name from tb_dealer where id=a.second_dealer_id) as proxyName1
        FROM
        tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
        1 = 1
        <if test="merchantName != null and merchantName != ''">
            AND a.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>

        <if test="mobile != null and mobile != ''">
            AND a.mobile LIKE CONCAT('%',#{mobile},'%')
        </if>

        <if test="status != null">
            AND a.status = #{status}
        </if>

        <if test="proxyName != null and proxyName!=''">
            AND a.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <if test="proxyName1 != null and proxyName1!=''">
            AND a.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
        </if>
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>

        <if test="startTime1!=null and startTime1!=''">
            AND a.authentication_time <![CDATA[ >= ]]> #{startTime1}
        </if>

        <if test="endTime1!=null and endTime1!=''">
            AND a.authentication_time <![CDATA[ <= ]]> #{endTime1}
        </if>

        <if test="startTime2!=null and startTime2!=''">
            AND a.checked_time <![CDATA[ >= ]]> #{startTime2}
        </if>
        <if test="endTime2!=null and endTime2!=''">
            AND a.checked_time <![CDATA[ <= ]]> #{endTime2}
        </if>
        <if test="markCode!=null and markCode!=''">
            AND a.mark_code LIKE CONCAT('%',#{markCode},'%')
        </if>
        ORDER BY
        create_time DESC
        LIMIT #{offset},#{pageSize}

    </select>

    <!-- 下载 -->
    <select id="downloade"  resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT
        a.mark_code,
        a.id,
        a.source,
        a.merchant_name,
        a.mobile,
        a. STATUS,
        a.dealer_id,
        a.create_time,
        a.authentication_time,
        a.checked_time,
        (select proxy_name from tb_dealer where id=a.first_dealer_id) as proxyName,
        (select proxy_name from tb_dealer where id=a.second_dealer_id) as proxyName1
        FROM
        tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
        1 = 1
        <if test="merchantName != null and merchantName != ''">
            AND a.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>

        <if test="mobile != null and mobile != ''">
            AND a.mobile LIKE CONCAT('%',#{mobile},'%')
        </if>

        <if test="status != null">
            AND a.status = #{status}
        </if>

        <if test="proxyName != null and proxyName!=''">
            AND a.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <if test="proxyName1 != null and proxyName1!=''">
            AND a.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
        </if>
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>

        <if test="startTime1!=null and startTime1!=''">
            AND a.authentication_time <![CDATA[ >= ]]> #{startTime1}
        </if>

        <if test="endTime1!=null and endTime1!=''">
            AND a.authentication_time <![CDATA[ <= ]]> #{endTime1}
        </if>

        <if test="startTime2!=null and startTime2!=''">
            AND a.checked_time <![CDATA[ >= ]]> #{startTime2}
        </if>
        <if test="endTime2!=null and endTime2!=''">
            AND a.checked_time <![CDATA[ <= ]]> #{endTime2}
        </if>
        <if test="markCode!=null and markCode!=''">
            AND a.mark_code LIKE CONCAT('%',#{markCode},'%')
        </if>
        ORDER BY
        create_time DESC
    </select>

    <!-- 下载 -->
    <select id="downloade1"  resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT
        a.mark_code,
        a.id,
        a.source,
        a.merchant_name,
        a.mobile,
        a. STATUS,
        a.dealer_id,
        a.create_time,
        a.authentication_time,
        a.checked_time,
        (select proxy_name from tb_dealer where id=a.first_dealer_id) as proxyName,
        (select proxy_name from tb_dealer where id=a.second_dealer_id) as proxyName1
        FROM
        tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
        1 = 1
        <if test="merchantName != null and merchantName != ''">
            AND a.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>

        <if test="mobile != null and mobile != ''">
            AND a.mobile LIKE CONCAT('%',#{mobile},'%')
        </if>

        <if test="status != null">
            AND a.status in (#{status},6)
        </if>

        <if test="proxyName != null and proxyName!=''">
            AND a.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <if test="proxyName1 != null and proxyName1!=''">
            AND a.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
        </if>
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>

        <if test="startTime1!=null and startTime1!=''">
            AND a.authentication_time <![CDATA[ >= ]]> #{startTime1}
        </if>

        <if test="endTime1!=null and endTime1!=''">
            AND a.authentication_time <![CDATA[ <= ]]> #{endTime1}
        </if>

        <if test="startTime2!=null and startTime2!=''">
            AND a.checked_time <![CDATA[ >= ]]> #{startTime2}
        </if>
        <if test="endTime2!=null and endTime2!=''">
            AND a.checked_time <![CDATA[ <= ]]> #{endTime2}
        </if>
        <if test="markCode!=null and markCode!=''">
            AND a.mark_code LIKE CONCAT('%',#{markCode},'%')
        </if>
        ORDER BY
        create_time DESC
    </select>


    <!--查询待审核商户-->
    <select id="getRecord"  resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">

        SELECT
        mark_code,
        id,
        merchant_name,
        STATUS,
        dealer_id,
        create_time,
        authentication_time,
        checked_time,
        (select d.proxy_name from tb_dealer as d where d.id=first_dealer_id) as proxy_name,
        (select d.proxy_name from tb_dealer as d where d.id=second_dealer_id) as proxy_name1
        FROM
        tb_merchant_info
        WHERE 1=1
        <if test="merchantName != null and merchantName != ''">
            AND merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>

        <if test="status != null">
            AND status=#{status}
        </if>

        <if test="startTime!=null and startTime!=''">
            AND create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND create_time <![CDATA[ <= ]]> #{endTime}
        </if>

        <if test="startTime1!=null and startTime1!=''">
            AND authentication_time <![CDATA[ >= ]]> #{startTime1}
        </if>

        <if test="endTime1!=null and endTime1!=''">
            AND authentication_time <![CDATA[ <= ]]> #{endTime1}
        </if>

        <if test="startTime2!=null and startTime2!=''">
            AND checked_time <![CDATA[ >= ]]> #{startTime2}
        </if>
        <if test="endTime2!=null and endTime2!=''">
            AND checked_time <![CDATA[ <= ]]> #{endTime2}
        </if>
        ORDER BY
        create_time DESC
        LIMIT #{offset},#{pageSize}

    </select>

    <select id="getProxyName"  resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">

        SELECT
          proxy_name
        FROM
          tb_dealer
        WHERE
          id=#{firstLevelDealerId}
    </select>

    <select id="getProxyName1"  resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">

        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id=#{firstLevelDealerId}
    </select>

    <select id="getPhoto"  resultType="com.jkm.hss.merchant.entity.HistoryPhotoChangeResponse">
        SELECT
            bank_pic,
            bank_hand_pic,
            identity_hand_pic,
            identity_face_pic,
            identity_opposite_pic
        FROM
            tb_merchant_info
        WHERE
            id=#{merchantId}
    </select>

    <select id="getHsyPhoto"  resultType="com.jkm.hss.merchant.entity.HsyHistoryPhotoChangeResponse">
        SELECT
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=c.LICENCEID) AS LICENCEID,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=c.STOREFRONTID) AS STOREFRONTID,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=c.COUNTERID) AS COUNTERID,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=c.INDOORID) AS INDOORID,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=b.IDCARDF) AS IDCARDF,
            (SELECT a.PATH FROM app_cm_file a WHERE a.UUID=b.IDCARDB) AS IDCARDB
        FROM
            app_biz_shop c
        LEFT JOIN app_biz_shop_user_role d ON d.SID=c.ID
        LEFT JOIN app_au_user b ON b.ID=d.UID
        LEFT JOIN app_biz_card e ON e.SID=c.ID
        WHERE c.ID=#{sid} AND d.TYPE=1 AND d.role=1
    </select>

    <insert id="saveHistory" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_history_photo_change
        (
        merchant_id,
        pohto,
        type,
        reason_description,
        card_name,
        operator
        )
        VALUES
        (
        #{merchantId},
        #{photo},
        #{type},
        #{reasonDescription},
        #{cardName},
        #{operator}
        );
    </insert>

    <insert id="saveHsyHistory" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_history_photo_change
        (
        sid,
        pohto,
        hsy_type,
        reason_description,
        card_name,
        operator
        )
        VALUES
        (
        #{sid},
        #{photo},
        #{hsyType},
        #{reasonDescription},
        #{cardName},
        #{operator}
        );
    </insert>

    <update id="savePhotoChang">
        UPDATE tb_merchant_info
        SET bank_pic=#{photoName}
        WHERE id = #{merchantId}
    </update>

    <update id="savePhotoChang1">
        UPDATE tb_merchant_info
        SET bank_hand_pic=#{photoName}
        WHERE id = #{merchantId}
    </update>

    <update id="savePhotoChang2">
        UPDATE tb_merchant_info
        SET identity_hand_pic=#{photoName}
        WHERE id = #{merchantId}
    </update>

    <update id="savePhotoChang3">
        UPDATE tb_merchant_info
        SET identity_face_pic=#{photoName}
        WHERE id = #{merchantId}
    </update>

    <update id="savePhotoChang4">
        UPDATE tb_merchant_info
        SET identity_opposite_pic=#{photoName}
        WHERE id = #{merchantId}
    </update>

    <select id="selectHistory"  resultType="com.jkm.hss.merchant.entity.HistoryPhotoChangeResponse">
        SELECT
            *
        FROM
            tb_history_photo_change
        WHERE
            merchant_id = #{merchantId}
        ORDER BY
            create_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="selectHistoryCount"  resultType="java.lang.Integer">
        SELECT
            COUNT(1)
        FROM
            tb_history_photo_change
        WHERE
            merchant_id = #{merchantId}
        ORDER BY
            create_time DESC
    </select>

    <!--- 以下六个hsy图片更新 -->
    <update id="saveHsyPhotoChang">
        UPDATE    app_au_user a
        LEFT JOIN app_biz_shop_user_role b ON a.ID=b.UID
        LEFT JOIN app_biz_shop c ON c.ID=b.SID
        SET a.IDCARDF = #{photoName} WHERE c.ID=#{sid} AND b.ROLE=1 AND b.TYPE=1;
    </update>

    <update id="saveHsyPhotoChang1">
        UPDATE    app_au_user a
        LEFT JOIN app_biz_shop_user_role b ON a.ID=b.UID
        LEFT JOIN app_biz_shop c ON c.ID=b.SID
        SET a.IDCARDB = #{photoName} WHERE c.ID=#{sid} AND b.ROLE=1 AND b.TYPE=1;
    </update>

    <update id="saveHsyPhotoChang2">
        UPDATE app_biz_shop SET LICENCEID = #{photoName} WHERE ID=#{sid}
    </update>

    <update id="saveHsyPhotoChang3">
        UPDATE app_biz_shop SET STOREFRONTID = #{photoName} WHERE ID=#{sid}
    </update>

    <update id="saveHsyPhotoChang4">
        UPDATE app_biz_shop SET COUNTERID = #{photoName} WHERE ID=#{sid}
    </update>

    <update id="saveHsyPhotoChang5">
        UPDATE app_biz_shop SET INDOORID = #{photoName} WHERE ID=#{sid}
    </update>

</mapper>