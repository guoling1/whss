<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.merchant.dao.QueryMerchantInfoRecordDao">

    <select id="getAll" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT
            a.id,
            a.identity_face_pic,
            a.identity_opposite_pic,
            a.identity_hand_pic,
            a.bank_hand_pic,
            a.bank_pic,
            a.reserve_mobile,
            a.merchant_name,
            a.merchant_change_name,
            a.address,
            a.source,
            a. NAME,
            a.identity,
            a.bank_no,
            a.dealer_id,
            a. STATUS,
            a.bank_name,
            a.first_merchant_id,
            a.first_dealer_id,
            a.second_dealer_id,
            a.is_authen,
            a.create_time,
            a.mobile,
            a.authentication_time,
            a.checked_time,
            a.second_merchant_id,
            a.account_id,
            <if test="status==2">
                a.branch_code,
                a.branch_name,
            </if>
            <if test="status==3 or status==6">
                (SELECT branch_code FROM tb_account_bank WHERE account_id=#{accountId} AND is_default=1 AND card_type=0 AND status=0) AS branchCode,
                (SELECT branch_name FROM tb_account_bank WHERE account_id=#{accountId} AND is_default=1 AND card_type=0 AND status=0) AS branchName,
            </if>
            (
                SELECT
                    proxy_name
                FROM
                    tb_dealer
                WHERE
                    id = a.first_dealer_id
            ) AS proxyName,
            (
                SELECT
                    proxy_name
                FROM
                    tb_dealer
                WHERE
                    id = a.second_dealer_id
            ) AS proxyName1,
            (SELECT proxy_name FROM tb_dealer WHERE id = a.oem_id ) AS branchCompany,
            (SELECT mark_code FROM tb_dealer WHERE id = a.oem_id ) AS companyCode,
            a.oem_id,
            b.mark_code AS markCode1,
            b.first_level_dealer_id,
            b.`level`
        FROM
            tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
			a.id=#{id}
    </select>

    <!--查询推荐信息-->
    <select id="getRefInformation" resultType="com.jkm.hss.merchant.entity.ReferralResponse">
        SELECT
            (select d.proxy_name from tb_dealer as d where d.id=first_dealer_id) as proxy_name_yq,
            (select d.proxy_name from tb_dealer as d where d.id=second_dealer_id) as proxy_name_yq1
        FROM tb_merchant_info WHERE id=#{id}
    </select>

    <!--查询所属一级代理商名称-->
    <select id="selectProxyNameYq" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
       SELECT
            a.mark_code,
            a.mobile,
            a.merchant_name,
            a.first_dealer_id,
            a.second_dealer_id
        FROM
            tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
            a.id =#{firstMerchantId}
    </select>

    <!--查询所属二级代理商名称-->
    <select id="selectProxyNameYq1" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT
            a.mark_code,
            a.mobile,
            a.merchant_name,
            a.first_dealer_id,
            a.second_dealer_id
        FROM
            tb_merchant_info a
        LEFT JOIN tb_dealer b ON a.dealer_id = b.id
        WHERE
            a.id =#{secondMerchantId}
    </select>

    <!--查询所属一级代理商名称-->
    <select id="selectProxyNameTJ" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT
            proxy_name
        FROM
            tb_dealer
        WHERE
            id = #{firstDealerId}
    </select>

    <!--查询所属二级代理商名称-->
    <select id="selectProxyNameTJ1" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT
            proxy_name
        FROM
            tb_dealer
        WHERE
            id = #{secondDealerId}
    </select>

    <!--审核日志-->
    <select id="getLog" resultType="com.jkm.hss.merchant.entity.LogResponse">

        SELECT
            name,
            descr,
            status,
            create_time
        FROM
            tb_merchant_info_check_record
        WHERE
            merchant_id = #{id}
    </select>

    <select id="getLevel" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT proxy_name,first_level_dealer_id FROM tb_dealer WHERE id=#{dealerId}

    </select>

    <select id="getResults" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT proxy_name FROM tb_dealer WHERE id=#{dealerId} AND level=#{level}

    </select>

    <select id="getFirstLevel" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
        SELECT proxy_name FROM tb_dealer WHERE id=#{firstLevelDealerId}

    </select>


    <select id="getSettle" resultType="com.jkm.hss.merchant.entity.SettleResponse">
        SELECT weixin_rate,alipay_rate,fast_rate FROM tb_merchant_info WHERE id=#{id}
    </select>

    <!-- 查询推荐信息 -->
    <select id="getrecommenderInfo" resultType="com.jkm.hss.merchant.entity.MerchantInfoResponse">
      SELECT
        mobile,mark_code,merchant_name
      FROM
        tb_merchant_info
      WHERE
	    id = (SELECT recommend_merchant_id FROM tb_recommend WHERE merchant_id=#{id} AND type=1);
    </select>

    <!-- 补填联行号 -->
    <update id="saveNo">
        UPDATE tb_merchant_info
        SET  branch_code = #{branchCode},
             branch_name = #{bankName},
             district_code = #{branchCountyCode}
        WHERE id=#{id}
    </update>

    <!-- 补填联行号 -->
    <update id="saveNo1">
        UPDATE tb_account_bank
        SET  branch_code = #{branchCode},
             branch_name = #{bankName},
             branch_province_code = #{branchProvinceCode},
             branch_province_name = #{branchProvinceName},
             branch_city_code = #{branchCityCode},
             branch_city_name = #{branchCityName},
             branch_county_code = #{branchCountyCode},
             branch_county_name = #{branchCountyName}
        WHERE account_id=#{accountId} AND is_default=1 and card_type=0 and status=0
    </update>
    <select id="getStatus" resultType="java.lang.Integer">
        SELECT status FROM tb_merchant_info WHERE id = #{id}
    </select>

    <select id="getAccountId" resultType="java.lang.Integer">
        SELECT account_id FROM tb_merchant_info WHERE id = #{id}
    </select>
</mapper>