<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jkm.hss.merchant.dao.OrderRecordDao">

	<!-- 通用查询结果列-->
	<sql id="Base_Column_List">
		 id,	order_id,	merchant_id,merchant_type,	product_name,	sub_name,	pay_channel,	total_fee, real_fee,service_fee,channel_fee,pay_result,	settle_period,	settle_status,	out_trade_no,	pay_params,	result_params,	error_message,	body,	pay_time,	trade_type,	status,	create_time,	update_time
	</sql>
	<!--查询交易明细总条数-->
	<select id="selectAllOrderRecordCount" resultType="java.lang.Long">
		SELECT COUNT(1) FROM tb_order_record WHERE merchant_id = #{merchantId} AND status=0 AND trade_type=0
		<if test="startDate!=null and startDate!=''">
			AND create_time <![CDATA[ >= ]]> #{startDate}
		</if>
		<if test="endDate!=null and endDate!=''">
			AND create_time <![CDATA[ <= ]]> #{endDate}
		</if>
		<if test="orderId!=null">
			AND order_id = #{orderId}
		</if>
	</select>
	<!--分页查询交易明细记录-->
	<select id="selectAllOrderRecordByPage" resultType="com.jkm.hss.merchant.entity.OrderRecord">
		SELECT <include refid="Base_Column_List" /> FROM tb_order_record
		WHERE merchant_id = #{merchantId} AND status=0 AND trade_type=0
		<if test="startDate!=null and startDate!=''">
			AND create_time <![CDATA[ >= ]]> #{startDate}
		</if>
		<if test="endDate!=null and endDate!=''">
			AND create_time <![CDATA[ <= ]]> #{endDate}
		</if>
		<if test="orderId!=null">
			AND order_id = #{orderId}
		</if>
		ORDER BY create_time DESC limit #{offset}, #{size}
	</select>

	<select id="selectBalanceCount" resultType="java.lang.Long">
		SELECT COUNT(1) FROM tb_order_record WHERE merchant_id = #{merchantId} AND status=0 and pay_result='S' and trade_type=0 and merchant_type=0
	</select>

	<select id="selectBalanceByPage" resultType="com.jkm.hss.merchant.entity.OrderRecord">
		SELECT <include refid="Base_Column_List" /> FROM tb_order_record
		WHERE merchant_id = #{merchantId} AND status=0 and pay_result='S' and trade_type=0 and merchant_type=0
		ORDER BY create_time DESC limit #{offset}, #{size}
	</select>

	<select id="selectOrderId" resultType="com.jkm.hss.merchant.entity.OrderRecord">
		SELECT
		<include refid="Base_Column_List" />
		FROM tb_order_record
		WHERE order_id = #{orderId} and status=0 and trade_type = #{tradeType}
	</select>
	<!-- 查询（根据主键ID查询） -->
	<select id="selectByPrimaryKey" resultType="com.jkm.hss.merchant.entity.OrderRecord">
		 SELECT
		 <include refid="Base_Column_List" />
		 FROM tb_order_record
		 WHERE id = #{id} and status=0
	</select>



	<!-- 添加 （匹配有值的字段）-->
	<insert id="insertSelective" useGeneratedKeys="true" keyProperty="id">
		 INSERT INTO tb_order_record
		 <trim prefix="(" suffix=")" suffixOverrides="," >
			<if test="orderId != null">
				 order_id,
			</if>
			<if test="merchantId != null">
				 merchant_id,
			</if>
			 <if test="merchantType != null">
				 merchant_type,
			 </if>
			<if test="productName != null">
				 product_name,
			</if>
			<if test="subName != null">
				 sub_name,
			</if>
			<if test="payChannel != null">
				 pay_channel,
			</if>
			<if test="totalFee != null">
				 total_fee,
			</if>
             <if test="realFee != null">
                 real_fee,
             </if>
			<if test="serviceFee != null">
				 service_fee,
			</if>
             <if test="channelFee != null">
                 channel_fee,
             </if>
			<if test="payResult != null">
				 pay_result,
			</if>
			<if test="settlePeriod != null">
				 settle_period,
			</if>
			<if test="settleStatus != null">
				 settle_status,
			</if>
			<if test="outTradeNo != null">
				 out_trade_no,
			</if>
			<if test="payParams != null">
				 pay_params,
			</if>
			<if test="resultParams != null">
				 result_params,
			</if>
			<if test="errorMessage != null">
				 error_message,
			</if>
			<if test="body != null">
				 body,
			</if>
			<if test="payTime != null">
				 pay_time,
			</if>
			<if test="tradeType != null">
				 trade_type,
			</if>
			<if test="status != null">
				 status,
			</if>
		 </trim>
		 <trim prefix="values (" suffix=")" suffixOverrides="," >
			<if test="orderId!=null">
				 #{orderId},
			</if>
			<if test="merchantId!=null">
				 #{merchantId},
			</if>
			 <if test="merchantType != null">
				 #{merchantType},
			 </if>
			<if test="productName!=null">
				 #{productName},
			</if>
			<if test="subName!=null">
				 #{subName},
			</if>
			<if test="payChannel!=null">
				 #{payChannel},
			</if>
			<if test="totalFee!=null">
				 #{totalFee},
			</if>
             <if test="realFee != null">
                 #{realFee},
             </if>
			<if test="serviceFee!=null">
				 #{serviceFee},
			</if>
             <if test="channelFee != null">
                 #{channelFee},
             </if>
			<if test="payResult!=null">
				 #{payResult},
			</if>
			<if test="settlePeriod!=null">
				 #{settlePeriod},
			</if>
			<if test="settleStatus!=null">
				 #{settleStatus},
			</if>
			<if test="outTradeNo!=null">
				 #{outTradeNo},
			</if>
			<if test="payParams!=null">
				 #{payParams},
			</if>
			<if test="resultParams!=null">
				 #{resultParams},
			</if>
			<if test="errorMessage!=null">
				 #{errorMessage},
			</if>
			<if test="body!=null">
				 #{body},
			</if>
			<if test="payTime!=null">
				 #{payTime},
			</if>
			<if test="tradeType!=null">
				 #{tradeType},
			</if>
			<if test="status!=null">
				 #{status},
			</if>
		 </trim>
	</insert>

	<!-- 修 改-->
	<update id="updateByPrimaryKeySelective">
		 UPDATE tb_order_record
 		 <set> 
			<if test="orderId != null">
				 order_id = #{orderId},
			</if>
			<if test="merchantId != null">
				 merchant_id = #{merchantId},
			</if>
			<if test="productName != null">
				 product_name = #{productName},
			</if>
			<if test="subName != null">
				 sub_name = #{subName},
			</if>
			<if test="payChannel != null">
				 pay_channel = #{payChannel},
			</if>
			<if test="totalFee != null">
				 total_fee = #{totalFee},
			</if>
             <if test="realFee != null">
                 real_fee = #{realFee},
             </if>
			<if test="serviceFee != null">
				 service_fee = #{serviceFee},
			</if>
             <if test="channelFee != null">
                 channel_fee = #{channelFee},
             </if>
			<if test="payResult != null">
				 pay_result = #{payResult},
			</if>
			<if test="settlePeriod != null">
				 settle_period = #{settlePeriod},
			</if>
			<if test="settleStatus != null">
				 settle_status = #{settleStatus},
			</if>
			<if test="outTradeNo != null">
				 out_trade_no = #{outTradeNo},
			</if>
			<if test="payParams != null">
				 pay_params = #{payParams},
			</if>
			<if test="resultParams != null">
				 result_params = #{resultParams},
			</if>
			<if test="errorMessage != null">
				 error_message = #{errorMessage},
			</if>
			<if test="body != null">
				 body = #{body},
			</if>
			<if test="payTime != null">
				 pay_time = #{payTime},
			</if>
			<if test="tradeType != null">
				 trade_type = #{tradeType},
			</if>
			<if test="status != null">
				 status = #{status},
			</if>
 		 </set>
		 WHERE id = #{id}
	</update>

	<!-- 修 改-->
	<update id="updateParam">
		UPDATE tb_order_record set result_params = #{resultParams},out_trade_no = #{outTradeNo} WHERE id = #{id}
	</update>

	<!-- 根据传入的条件查询 -->
	<select id="selectOrderRecordByConditions" resultType="com.jkm.hss.merchant.entity.OrderRecordConditions" parameterType="com.jkm.hss.merchant.entity.OrderRecordConditions">
		SELECT o.update_time,o.order_id,o.merchant_id,o.sub_name,o.total_fee,o.pay_result,o.pay_channel,bank_no,mobile
		FROM tb_order_record o
		LEFT JOIN tb_merchant_info m
		ON o.merchant_id = m.id
		WHERE 1 = 1
		<if test="startTime!=null">
			AND o.update_time &gt;#{startTime}
		</if>
		<if test="endTime!=null">
			AND o.update_time &lt; #{endTime}
		</if>
		<if test="orderId != null">
			AND o.order_id = #{orderId}
		</if>
		<if test="merchantId != null">
			AND o.merchant_id = #{merchantId}
		</if>
		<if test="subName != null">
			AND o.sub_name = #{subName}
		</if>
		<if test="lessTotalFee != null">
			AND o.total_fee &gt; #{lessTotalFee}
		</if>
		<if test="moreTotalFee != null">
			AND o.total_fee &lt; #{moreTotalFee}
		</if>
		<if test="payResult != null">
			AND o.pay_result = #{payResult}
		</if>
		<if test="payChannel != 0">
			AND o.pay_channel = #{payChannel}
		</if>
		<if test="mdMobile != null">
			AND md_mobile = #{mdMobile}
		</if>
		ORDER BY o.update_time DESC
		<if test="pageNo != -1">
			LIMIT ${pageNo},${pageSize}
		</if>
	</select>

	<select id="selectOrderRecordByConditionsCount" parameterType="com.jkm.hss.merchant.entity.OrderRecordConditions" resultType="java.lang.Integer">
		SELECT COUNT(0) FROM tb_order_record
        WHERE 1 = 1
		<if test="startTime != null">
			AND update_time &gt; #{startTime}
		</if>
		<if test="endTime != null">
			AND update_time &lt; #{endTime}
		</if>
		<if test="orderId != null">
			AND order_id = #{orderId}
		</if>
		<if test="merchantId != null">
			AND merchant_id = #{merchantId}
		</if>
		<if test="subName != null">
			AND sub_name = #{subName}
		</if>
		<if test="lessTotalFee != null">
			AND total_fee &gt; ${lessTotalFee}
		</if>
		<if test="moreTotalFee != null">
			AND total_fee &lt; ${moreTotalFee}
		</if>
		<if test="payResult != null">
			AND pay_result = #{payResult}
		</if>
		<if test="payChannel != 0">
			AND pay_channel = #{payChannel}
		</if>
	</select>


	<!--定时轮训代付结果的条件-->
	<select id="selectOtherPayByConditions" resultType="com.jkm.hss.merchant.entity.OrderRecord">
		select <include refid="Base_Column_List" /> from tb_order_record where  trade_type = 1 and pay_result in ('H','A','W')  and status=0 order by create_time desc
	</select>
	<!--定时轮训支付结果的条件-->
	<select id="selectPayByConditions" resultType="com.jkm.hss.merchant.entity.OrderRecord">
		select <include refid="Base_Column_List" /> from tb_order_record where  trade_type = 0 and pay_result in ('A')  and status=0 order by create_time desc
	</select>



	<!--查询提现明细总条数-->
	<select id="selectDrawWithCount" resultType="java.lang.Long">
		SELECT count(r.id)
		FROM tb_order_record  r
		LEFT JOIN tb_merchant_info m on r.merchant_id =m.id
		WHERE   r.trade_type=1 and r.status= 0
		<if test="orderId!=null and orderId!=''">
			AND r.order_id LIKE CONCAT('%',#{orderId})
		</if>
		<if test="merchantId!=null and merchantId!=''">
			AND r.merchant_id =  #{merchantId}
		</if>
		<if test="payResults!=null and payResults.size()>0">
			AND r.pay_result in
			<foreach item="item" index="index" collection="payResults" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="name!=null and name!=''">
			AND m.name =  #{name}
		</if>
		<if test="mobile!=null and mobile!=''">
			AND m.md_mobile =  #{mobile}
		</if>
		<if test="bankNoShort!=null and bankNoShort!=''">
			AND m.bank_no_short LIKE CONCAT('%',#{bankNoShort})
		</if>
		<if test="startDate!=null and startDate!=''">
			AND r.create_time <![CDATA[ >= ]]> #{startDate}
		</if>
		<if test="endDate!=null and endDate!=''">
			AND r.create_time <![CDATA[ <= ]]> #{endDate}
		</if>
		<if test="payStartDate!=null and payStartDate!=''">
			AND r.pay_time <![CDATA[ >= ]]> #{payStartDate}
		</if>
		<if test="payEndDate!=null and payEndDate!=''">
			AND r.pay_time <![CDATA[ <= ]]> #{payEndDate}
		</if>
	</select>
	<!--分页查询提现记录-->
	<select id="selectDrawWithRecordByPage" resultType="com.jkm.hss.merchant.entity.OrderRecordAndMerchant">
		SELECT r.id,
		r.order_id,
		r.merchant_id,
		r.merchant_type,
		r.product_name,
		r.pay_channel,
		r.total_fee,
		r.real_fee,
		r.service_fee,
		r.channel_fee,
		r.pay_result,
		r.out_trade_no,
		r.pay_params,
		r.result_params,
		r.error_message,
		r.body,
		r.pay_time,
		r.create_time,
		r.update_time,
		m.mobile,
		m.md_mobile,
		m.bank_no_short,
		m.reserve_mobile,
		m.merchant_name,
		m.address,
		m.name,
		m.identity,
		m.bank_name,
		m.bank_no
		FROM tb_order_record  r
		LEFT JOIN tb_merchant_info m on r.merchant_id =m.id
		WHERE   r.trade_type=1 and r.status= 0
		<if test="orderId!=null and orderId!=''">
			AND r.order_id LIKE CONCAT('%',#{orderId})
		</if>
		<if test="merchantId!=null and merchantId!=''">
			AND r.merchant_id =  #{merchantId}
		</if>
		<if test="payResults!=null and payResults.size()>0">
			AND r.pay_result in
			<foreach item="item" index="index" collection="payResults" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="name!=null and name!=''">
			AND m.name =  #{name}
		</if>
		<if test="mobile!=null and mobile!=''">
			AND m.md_mobile =  #{mobile}
		</if>
		<if test="bankNoShort!=null and bankNoShort!=''">
			AND m.bank_no_short LIKE CONCAT('%',#{bankNoShort})
		</if>
		<if test="startDate!=null and startDate!=''">
			AND r.create_time <![CDATA[ >= ]]> #{startDate}
		</if>
		<if test="endDate!=null and endDate!=''">
			AND r.create_time <![CDATA[ <= ]]> #{endDate}
		</if>
		<if test="payStartDate!=null and payStartDate!=''">
			AND r.pay_time <![CDATA[ >= ]]> #{payStartDate}
		</if>
		<if test="payEndDate!=null and payEndDate!=''">
			AND r.pay_time <![CDATA[ <= ]]> #{payEndDate}
		</if>
		ORDER BY r.create_time DESC
		limit #{offset}, #{size}
	</select>


	<!-- 交易记录 -->
	<select id="selectOrderList" resultType="com.jkm.hss.merchant.entity.MerchantAndOrderRecord">
		SELECT o.id,o.order_id,o.merchant_id,o.sub_name,o.pay_channel,o.total_fee,o.real_fee,o.trade_type,
		o.service_fee,o.channel_fee,o.pay_result,o.settle_status,o.out_trade_no,o.error_message,
		o.create_time,m.mobile,(SELECT a.proxy_name FROM tb_dealer a WHERE a.id=m.dealer_id) AS proxyName,
		(SELECT b.channel_name FROM tb_basic_channel b WHERE b.channel_type_sign=o.pay_channel) AS channelName
		FROM tb_order_record o
		LEFT JOIN tb_merchant_info m
		ON o.merchant_id = m.id
		WHERE o.trade_type=0 and o.status= 0
		<if test="startTime!=null and startTime!=''">
			AND o.create_time <![CDATA[ >= ]]> #{startTime}
		</if>
		<if test="endTime!=null and endTime!=''">
			AND o.create_time <![CDATA[ <= ]]> #{endTime}
		</if>
		<if test="orderId != null and orderId!=''">
			AND o.order_id LIKE CONCAT('%',#{orderId})
		</if>
		<if test="merchantId != null and merchantId!=''">
			AND o.merchant_id = #{merchantId}
		</if>
		<if test="subName != null and subName!=''">
			AND o.sub_name = #{subName}
		</if>
		<if test="lessTotalFee != null and lessTotalFee!=''">
			AND o.total_fee <![CDATA[ >= ]]> #{lessTotalFee}
		</if>
		<if test="moreTotalFee != null and moreTotalFee!=''">
			AND o.total_fee <![CDATA[ <= ]]> #{moreTotalFee}
		</if>
		<if test="payResults!=null and payResults.size()>0">
			AND o.pay_result in
			<foreach item="item" index="index" collection="payResults" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="payChannel != 0">
			AND o.pay_channel = #{payChannel}
		</if>
		<if test="mdMobile != null and mdMobile!=''">
			AND m.md_mobile = #{mdMobile}
		</if>
		<if test="settleStatus != null">
			AND o.settle_status = #{settleStatus}
		</if>
		ORDER BY o.create_time DESC
		limit #{offset}, #{size}
	</select>

	<!-- 交易详情 -->
	<select id="selectOrderListCountAll" resultType="com.jkm.hss.merchant.entity.MerchantAndOrderRecord">
		SELECT o.id,o.order_id,o.merchant_id,o.sub_name,o.pay_channel,o.total_fee,o.real_fee,o.trade_type,
		o.service_fee,o.channel_fee,o.pay_result,o.settle_status,o.out_trade_no,o.error_message,
		o.pay_time,o.settle_period,m.reserve_mobile,
		o.create_time,m.bank_no,m.mobile,(SELECT a.proxy_name FROM tb_dealer a WHERE a.id=m.dealer_id) AS proxyName,
		(SELECT b.channel_name FROM tb_basic_channel b WHERE b.channel_type_sign=o.pay_channel) AS channelName
		FROM tb_order_record o
		LEFT JOIN tb_merchant_info m
		ON o.merchant_id = m.id
		WHERE o.trade_type=0 and o.status= 0
		AND o.id=#{id}
	</select>

	<!-- 提现详情 -->
	<select id="selectDrawWithRecordByPageAll" resultType="com.jkm.hss.merchant.entity.OrderRecordAndMerchant">
		SELECT o.id,o.order_id,o.merchant_id,o.sub_name,o.pay_channel,o.total_fee,o.real_fee,o.trade_type,
		o.service_fee,o.channel_fee,o.pay_result,o.settle_status,o.out_trade_no,o.error_message,o.body,
		o.pay_time,o.settle_period,m.reserve_mobile,m.identity,m.bank_name,
		o.create_time,m.bank_no,m.mobile,(SELECT a.proxy_name FROM tb_dealer a WHERE a.id=m.dealer_id) AS proxyName,
		(SELECT b.channel_name FROM tb_basic_channel b WHERE b.channel_type_sign=o.pay_channel) AS channelName
		FROM tb_order_record o
		LEFT JOIN tb_merchant_info m
		ON o.merchant_id = m.id
		WHERE o.trade_type=1 and o.status= 0
		AND o.id=#{id}
	</select>

	<select id="selectOrderListCount"  resultType="java.lang.Integer">
		SELECT COUNT(1)
		FROM tb_order_record o
		LEFT JOIN tb_merchant_info m
		ON o.merchant_id = m.id
		WHERE o.trade_type=0 and o.status= 0
		<if test="startTime!=null and startTime!=''">
			AND o.create_time <![CDATA[ >= ]]> #{startTime}
		</if>
		<if test="endTime!=null and endTime!=''">
			AND o.create_time <![CDATA[ <= ]]> #{endTime}
		</if>
		<if test="orderId != null and orderId!=''">
			AND o.order_id LIKE CONCAT('%',#{orderId})
		</if>
		<if test="merchantId != null and merchantId!=''">
			AND o.merchant_id = #{merchantId}
		</if>
		<if test="subName != null and subName!=''">
			AND o.sub_name = #{subName}
		</if>
		<if test="lessTotalFee != null and lessTotalFee!=''">
			AND o.total_fee <![CDATA[ >= ]]> #{lessTotalFee}
		</if>
		<if test="moreTotalFee != null and moreTotalFee!=''">
			AND o.total_fee <![CDATA[ <= ]]> #{moreTotalFee}
		</if>
		<if test="payResults!=null and payResults.size()>0">
			AND o.pay_result in
			<foreach item="item" index="index" collection="payResults" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="payChannel != 0">
			AND o.pay_channel = #{payChannel}
		</if>
		<if test="mdMobile != null and mdMobile!=''">
			AND m.md_mobile = #{mdMobile}
		</if>
		<if test="settleStatus != null">
			AND o.settle_status = #{settleStatus}
		</if>
	</select>
</mapper>