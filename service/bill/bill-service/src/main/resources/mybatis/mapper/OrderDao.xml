<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.bill.dao.OrderDao">
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_order
        (
        pay_order_id,
        business_order_no,
        order_no,
        sn,
        trade_amount,
        real_pay_amount,
        app_id,
        trade_type,
        service_type,
        payer,
        payee,
        pay_account,
        pay_account_type,
        pay_type,
        pay_success_time,
        poundage,
        pay_rate,
        goods_name,
        goods_describe,
        settle_status,
        settle_time,
        settle_type,
        success_settle_time,
        pay_channel_sign,
        pay_bank_card,
        bank_expire_date,
        cvv,
        bank_trade_no,
        trade_card_no,
        trade_card_type,
        wechat_or_alipay_order_no,
        remark,
        status
        )
        VALUES
        (
        #{payOrderId},
        #{businessOrderNo},
        #{orderNo},
        #{sn},
        #{tradeAmount},
        #{realPayAmount},
        #{appId},
        #{tradeType},
        #{serviceType},
        #{payer},
        #{payee},
        #{payAccount},
        #{payAccountType},
        #{payType},
        #{paySuccessTime},
        #{poundage},
        #{payRate},
        #{goodsName},
        #{goodsDescribe},
        #{settleStatus},
        #{settleTime},
        #{settleType},
        #{successSettleTime},
        #{payChannelSign},
        #{payBankCard},
        #{bankExpireDate},
        #{cvv},
        #{bankTradeNo},
        #{tradeCardNo},
        #{tradeCardType},
        #{wechatOrAlipayOrderNo},
        #{remark},
        #{status}
        );
    </insert>

    <update id="update">
        UPDATE tb_order
        SET
        order_no = #{orderNo},
        sn = #{sn},
        trade_amount = #{tradeAmount},
        real_pay_amount = #{realPayAmount},
        trade_type = #{tradeType},
        payer = #{payer},
        payee = #{payee},
        pay_account = #{payAccount},
        pay_account_type = #{payAccountType},
        pay_type = #{payType},
        pay_success_time = #{paySuccessTime},
        poundage = #{poundage},
        pay_rate = #{payRate},
        goods_name = #{goodsName},
        goods_describe = #{goodsDescribe},
        settle_status = #{settleStatus},
        settle_time = #{settleTime},
        success_settle_time = #{successSettleTime},
        pay_channel_sign = #{payChannelSign},
        bank_trade_no = #{bankTradeNo},
        trade_card_no = #{tradeCardNo},
        trade_card_type = #{tradeCardType},
        wechat_or_alipay_order_no = #{wechatOrAlipayOrderNo},
        pay_info = #{payInfo},
        pay_salt = #{paySalt},
        pay_sign = #{paySign},
        remark = #{remark},
        status = #{status}
        WHERE id = #{id}
    </update>

    <update id="updateRemark">
        UPDATE tb_order SET remark = #{remark} WHERE id = #{id}
    </update>

    <update id="updateStatus">
        UPDATE tb_order SET status = #{status}, remark = #{remark} WHERE id = #{id}
    </update>

    <update id="updateSettleStatus">
        UPDATE tb_order SET settle_status = #{status}, success_settle_time = NOW() WHERE id = #{id}
    </update>

    <update id="updateCheckedStatus">
        UPDATE tb_order SET checked_status = #{checkedStatus} WHERE id = #{id}
    </update>

    <update id="markSettleSuccess">
        UPDATE tb_order SET settle_status = #{status}, success_settle_time = #{successSettleTime} WHERE id = #{id}
    </update>

    <select id="selectById" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE id = #{id}
    </select>

    <select id="selectByIdWithLock" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE id = #{id} FOR UPDATE
    </select>

    <!-- 提现列表 -->
    <select id="withdrawList" resultType="com.jkm.hss.bill.entity.WithdrawResponse">
        SELECT
            a.*, b.user_name,
            c.dealer_id,
            c.merchant_name,
            d.proxy_name,
            c.id AS idm,
            d.id AS idd
        FROM
          tb_order a
        LEFT JOIN tb_account b ON a.payer = b.id
        LEFT JOIN tb_merchant_info c ON b.id = c.account_id
        LEFT JOIN tb_dealer d ON b.id = d.account_id
        WHERE
          a.trade_type = 3
    <if test="businessOrderNo != null and businessOrderNo != ''">
        AND a.business_order_no = #{businessOrderNo}
    </if>
    <if test="orderNo != null and orderNo != ''">
        AND a.order_no = #{orderNo}
    </if>
    <if test="sn != null and sn != ''">
        AND a.sn = #{sn}
    </if>
    <if test="userName != null and userName != ''">
        AND b.user_name = #{userName}
    </if>
    <if test="startTime != null and startTime != ''">
        AND a.create_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and endTime != ''">
        AND a.create_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="status != null and status > 0">
        AND a.status = #{status}
    </if>
        ORDER BY
            a.create_time DESC
        LIMIT #{offset},#{pageSize}
    </select>

    <!-- 提现下载 -->
    <select id="withdrawList1" resultType="com.jkm.hss.bill.entity.WithdrawResponse">
        SELECT
        a.*, b.user_name,
        c.dealer_id,
        c.merchant_name,
        d.proxy_name,
        c.id AS idm,
        d.id AS idd
        FROM
        tb_order a
        LEFT JOIN tb_account b ON a.payer = b.id
        LEFT JOIN tb_merchant_info c ON b.id = c.account_id
        LEFT JOIN tb_dealer d ON b.id = d.account_id
        WHERE
        a.trade_type = 3
        <if test="businessOrderNo != null and businessOrderNo != ''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="orderNo != null and orderNo != ''">
            AND a.order_no = #{orderNo}
        </if>
        <if test="sn != null and sn != ''">
            AND a.sn = #{sn}
        </if>
        <if test="userName != null and userName != ''">
            AND b.user_name = #{userName}
        </if>
        <if test="startTime != null and startTime != ''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="status != null and status > 0">
            AND a.status = #{status}
        </if>
        ORDER BY
        a.create_time DESC
    </select>

    <!-- 提现统计 -->
    <select id="withdrawAmount" resultType="com.jkm.hss.bill.entity.WithdrawResponse">
        SELECT
            SUM(a.trade_amount) AS trade_amount,
            SUM(a.poundage) AS poundage
        FROM
          tb_order a
        LEFT JOIN tb_account b ON a.payer = b.id
        LEFT JOIN tb_merchant_info c ON b.id = c.account_id
        LEFT JOIN tb_dealer d ON b.id = d.account_id
        WHERE
          a.trade_type = 3
        <if test="businessOrderNo != null and businessOrderNo != ''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="orderNo != null and orderNo != ''">
            AND a.order_no = #{orderNo}
        </if>
        <if test="sn != null and sn != ''">
            AND a.sn = #{sn}
        </if>
        <if test="userName != null and userName != ''">
            AND b.user_name = #{userName}
        </if>
        <if test="startTime != null and startTime != ''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="status != null and status > 0">
            AND a.status = #{status}
        </if>
    </select>

    <!-- 提现详情代理商 -->
    <select id="withdrawDetail" resultType="com.jkm.hss.bill.entity.WithdrawResponse">
        SELECT
            a.*, c.proxy_name,
            c.mark_code AS markCodes,
            c.belong_area,
            c.belong_province_name,
            c.belong_city_name,
            c.`level`,
            c.first_level_dealer_id,
            c.mobile AS mobileD,
            c.create_time AS create_timeD
        FROM
            tb_order a
        LEFT JOIN tb_account b ON a.payer = b.id
        LEFT JOIN tb_dealer c ON b.id = c.account_id
        WHERE
            a.trade_type = 3
        AND c.id = #{idd}
        AND a.create_time = #{createTimes}
    </select>

    <!-- 提现详情商户 -->
    <select id="withdrawDetails" resultType="com.jkm.hss.bill.entity.WithdrawResponse">
        SELECT
            a.*, b.user_name,
            c.dealer_id,
            c.address,
            c.merchant_name,
            c.province_code,
            c.mark_code AS mark_codeM,
            c.mobile,
            c.create_time AS create_timeM,
            c.province_name,
            c.city_name,
            c.county_name,
            c.first_dealer_id,
            c.second_dealer_id,
          (select proxy_name from tb_dealer where id=c.first_dealer_id) as proxyNames,
          (select proxy_name from tb_dealer where id=c.second_dealer_id) as proxyName1
        FROM
            tb_order a
        LEFT JOIN tb_account b ON a.payer = b.id
        LEFT JOIN tb_merchant_info c ON b.id = c.account_id
        WHERE
            a.trade_type = 3
        AND c.id=#{idm}
        AND a.create_time=#{createTimes}
    </select>

    <!-- 提现总数 -->
    <select id="getNo" resultType="java.lang.Integer">
        SELECT
            COUNT(*)
        FROM
          tb_order a
        LEFT JOIN tb_account b ON a.payer = b.id
        LEFT JOIN tb_merchant_info c ON b.id = c.account_id
        LEFT JOIN tb_dealer d ON b.id = d.account_id
        WHERE
          a.trade_type = 3
    <if test="businessOrderNo != null and businessOrderNo != ''">
        AND a.business_order_no = #{businessOrderNo}
    </if>
    <if test="orderNo != null and orderNo != ''">
        AND a.order_no = #{orderNo}
    </if>
    <if test="sn != null and sn != ''">
        AND a.sn = #{sn}
    </if>
    <if test="userName != null and userName != ''">
        AND b.user_name = #{userName}
    </if>
    <if test="startTime != null and startTime != ''">
        AND a.create_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and endTime != ''">
        AND a.create_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="status != null and status > 0">
        AND a.status = #{status}
    </if>
    </select>

    <select id="selectByOrderNoAndTradeType" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE order_no = #{orderNo} AND trade_type = #{tradeType};
    </select>

    <select id="selectByPayOrderId" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE pay_order_id = #{payOrderId} AND trade_type = 3;
    </select>

    <select id="selectOrderList" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
            a.pay_order_id,
            a.business_order_no,
            a.order_no,
            a.trade_amount,
            a.real_pay_amount,
            a.trade_type,
            a.payer,
            a.payee,
            a.pay_account,
            a.pay_account_type,
            a.pay_type,
            a.pay_success_time,
            a.poundage,
            a.pay_rate,
            a.settle_status,
            a.settle_time,
            a.success_settle_time,
            a.pay_channel_sign,
            a.remark,
            a. STATUS,
            a.create_time,
            b.merchant_name,
            b.mark_code,
            a.sn,
            a.app_id,
            (select proxy_name from tb_dealer where id=b.first_dealer_id) as proxyName,
            (select proxy_name from tb_dealer where id=b.second_dealer_id) as proxyName1,
            x.SHORTNAME,
            x.GLOBALID
        FROM
            tb_order a
        LEFT JOIN tb_merchant_info b ON b.account_id=a.payee
        LEFT JOIN app_au_user z ON z.ACCOUNTID=a.payee
        LEFT JOIN app_biz_shop_user_role y ON y.UID=z.ID AND y.ROLE=1 AND y.TYPE=1
        LEFT JOIN app_biz_shop x  ON x.ID=y.SID
        WHERE
          a.trade_type = 1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="shortName != null and shortName!=''">
            AND x.SHORTNAME LIKE CONCAT('%',#{shortName},'%')
        </if>
        <if test="proxyName != null and proxyName!=''">
            AND b.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <if test="proxyName1 != null and proxyName1!=''">
            AND b.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
        </if>
        <if test="businessOrderNo != null and businessOrderNo!=''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="sn != null and sn!=''">
            AND a.sn = #{sn}
        </if>
        <if test="markCode != null and markCode!=''">
            AND b.mark_code = #{markCode}
        </if>
        <if test="globalId != null and globalId!=''">
            AND x.GLOBALID = #{globalId}
        </if>
        <if test="appId != null and appId!=''">
            AND a.app_id = #{appId}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>

        <if test="payChannelSign != null and payChannelSign > 0">
            AND a.pay_channel_sign = #{payChannelSign}
        </if>
        ORDER BY a.create_time DESC
        limit #{offset}, #{size}
    </select>

    <!-- 代理商pc交易查询二级 -->
    <select id="getTrade" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        a.pay_order_id,
        a.business_order_no,
        a.order_no,
        a.trade_amount,
        a.real_pay_amount,
        a.trade_type,
        a.payer,
        a.payee,
        a.pay_account,
        a.pay_account_type,
        a.pay_type,
        a.pay_success_time,
        a.poundage,
        a.pay_rate,
        a.settle_status,
        a.settle_time,
        a.settle_type,
        a.success_settle_time,
        a.pay_channel_sign,
        a.remark,
        a. STATUS,
        a.create_time,
        b.merchant_name,
        a.sn,
        a.app_id,
        (select proxy_name from tb_dealer where id=b.first_dealer_id) as proxyName,
        (select proxy_name from tb_dealer where id=b.second_dealer_id) as proxyName1
        FROM
        tb_order a
        LEFT JOIN tb_merchant_info b ON a.payee = b.account_id
        WHERE
        a.trade_type = 1 AND b.second_dealer_id=#{dealerId}
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="proxyName != null and proxyName!=''">
            AND b.dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <!--<if test="proxyName1 != null and proxyName1!=''">-->
            <!--AND b.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))-->
        <!--</if>-->
        <if test="businessOrderNo != null and businessOrderNo!=''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="sn != null and sn!=''">
            AND a.sn = #{sn}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        ORDER BY a.create_time DESC
        limit #{offset}, #{size}
    </select>

    <!-- 代理商pc交易查询二级总数 -->
    <select id="listCount" resultType="java.lang.Integer">
        SELECT
          COUNT(*)
        FROM
          tb_order a
        LEFT JOIN tb_merchant_info b ON a.payee = b.account_id
        WHERE
          a.trade_type = 1 AND b.second_dealer_id=#{dealerId}
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="proxyName != null and proxyName!=''">
            AND b.dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <!--<if test="proxyName1 != null and proxyName1!=''">-->
            <!--AND b.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))-->
        <!--</if>-->
        <if test="businessOrderNo != null and businessOrderNo!=''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="sn != null and sn!=''">
            AND a.sn = #{sn}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <!-- 代理商pc交易查询一级 -->
    <select id="getTradeFirst" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        a.pay_order_id,
        a.business_order_no,
        a.order_no,
        a.trade_amount,
        a.real_pay_amount,
        a.trade_type,
        a.payer,
        a.payee,
        a.pay_account,
        a.pay_account_type,
        a.pay_type,
        a.pay_success_time,
        a.poundage,
        a.pay_rate,
        a.settle_status,
        a.settle_time,
        a.settle_type,
        a.success_settle_time,
        a.pay_channel_sign,
        a.remark,
        a. STATUS,
        a.create_time,
        b.merchant_name,
        a.sn,
        a.app_id,
        (select proxy_name from tb_dealer where id=b.first_dealer_id) as proxyName,
        (select proxy_name from tb_dealer where id=b.second_dealer_id) as proxyName1
        FROM
        tb_order a
        LEFT JOIN tb_merchant_info b ON a.payee = b.account_id
        WHERE
        a.trade_type = 1 AND b.first_dealer_id=#{dealerId}
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="proxyName != null and proxyName!=''">
            AND b.dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <!--<if test="proxyName1 != null and proxyName1!=''">-->
            <!--AND b.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))-->
        <!--</if>-->
        <if test="businessOrderNo != null and businessOrderNo!=''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="sn != null and sn!=''">
            AND a.sn = #{sn}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        ORDER BY a.create_time DESC
        limit #{offset}, #{size}
    </select>

    <!-- 代理商pc交易查询一级总数 -->
    <select id="listFirstCount" resultType="java.lang.Integer">
        SELECT
          COUNT(*)
        FROM
          tb_order a
        LEFT JOIN tb_merchant_info b ON a.payee = b.account_id
        WHERE
          a.trade_type = 1 AND b.first_dealer_id=#{dealerId}
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="proxyName != null and proxyName!=''">
            AND b.dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <!--<if test="proxyName1 != null and proxyName1!=''">-->
            <!--AND b.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))-->
        <!--</if>-->
        <if test="businessOrderNo != null and businessOrderNo!=''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="sn != null and sn!=''">
            AND a.sn = #{sn}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <!-- 导出 -->
    <select id="downloadOrderList" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
            a.pay_order_id,
            a.business_order_no,
            a.order_no,
            a.trade_amount,
            a.real_pay_amount,
            a.trade_type,
            a.payer,
            a.payee,
            a.pay_account,
            a.pay_account_type,
            a.pay_type,
            a.pay_success_time,
            a.poundage,
            a.pay_rate,
            a.settle_status,
            a.settle_time,
            a.success_settle_time,
            a.pay_channel_sign,
            a.remark,
            a. STATUS,
            a.create_time,
            b.merchant_name,
            b.mark_code,
            a.sn,
            a.app_id,
            (select proxy_name from tb_dealer where id=b.first_dealer_id) as proxyName,
            (select proxy_name from tb_dealer where id=b.second_dealer_id) as proxyName1,
            x.SHORTNAME,
            x.GLOBALID
        FROM
            tb_order a
        LEFT JOIN tb_merchant_info b ON b.account_id=a.payee
        LEFT JOIN app_au_user z ON z.ACCOUNTID=a.payee
        LEFT JOIN app_biz_shop_user_role y ON y.UID=z.ID AND y.ROLE=1 AND y.TYPE=1
        LEFT JOIN app_biz_shop x  ON x.ID=y.SID
        WHERE
            a.trade_type = 1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="shortName != null and shortName!=''">
            AND x.SHORTNAME LIKE CONCAT('%',#{shortName},'%')
        </if>
        <if test="proxyName != null and proxyName!=''">
            AND b.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <if test="proxyName1 != null and proxyName1!=''">
            AND b.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
        </if>
        <if test="businessOrderNo != null and businessOrderNo!=''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="sn != null and sn!=''">
            AND a.sn = #{sn}
        </if>
        <if test="markCode != null and markCode!=''">
            AND b.mark_code = #{markCode}
        </if>
        <if test="globalId != null and globalId!=''">
            AND x.GLOBALID = #{globalId}
        </if>
        <if test="appId != null and appId!=''">
            AND a.app_id = #{appId}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>

        <if test="payChannelSign != null and payChannelSign > 0">
            AND a.pay_channel_sign = #{payChannelSign}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <select id="getOrderList" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
            a.pay_order_id,
            a.order_no,
            a.trade_amount,
            a.real_pay_amount,
            a.trade_type,
            a.payer,
            a.payee,
            a.pay_account,
            a.pay_account_type,
            a.pay_type,
            a.pay_success_time,
            a.poundage,
            a.pay_rate,
            a.settle_status,
            a.settle_time,
            a.success_settle_time,
            a.pay_channel_sign,
            a.remark,
            a. STATUS,
            a.create_time,
            b.merchant_name,
            a.sn,
            a.app_id,
            c.`level`,
            c.first_level_dealer_id,
            c.proxy_name
        FROM
          tb_order a
        LEFT JOIN tb_merchant_info b ON a.payee = b.account_id
        LEFT JOIN tb_dealer c ON b.dealer_id=c.id
        WHERE
          a.trade_type = 1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <!-- 交易详情 -->
    <select id="selectOrderListByPageAll" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
            a.pay_order_id,
            a.order_no,
            a.trade_amount,
            a.real_pay_amount,
            a.trade_type,
            a.payer,
            a.payee,
            a.pay_account,
            a.pay_account_type,
            a.pay_type,
            a.pay_success_time,
            a.poundage,
            a.pay_rate,
            a.settle_status,
            a.settle_time,
            a.success_settle_time,
            a.pay_channel_sign,
            a.remark,
            a. STATUS,
            a.create_time,
            b.merchant_name,
            b.mark_code,
            b.mobile,
            b.bank_no,
            b.reserve_mobile,
            b.mark_code,
            a.sn,
            a.app_id,
            a.settle_type,
            a.goods_describe,
            a.goods_name,
            c.`level`,
            c.first_level_dealer_id,
            c.proxy_name
        FROM
            tb_order a
        LEFT JOIN tb_merchant_info b ON a.payee = b.account_id
        LEFT JOIN tb_dealer c ON b.dealer_id=c.id
        WHERE
            a.trade_type = 1 AND a.order_no=#{orderNo}

    </select>

    <select id="selectOrderListCount"  resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM
        tb_order a
        LEFT JOIN tb_merchant_info b ON b.account_id=a.payee
        LEFT JOIN app_au_user z ON z.ACCOUNTID=a.payee
        LEFT JOIN app_biz_shop_user_role y ON y.UID=z.ID AND y.ROLE=1 AND y.TYPE=1
        LEFT JOIN app_biz_shop x  ON x.ID=y.SID
        WHERE
        a.trade_type = 1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="shortName != null and shortName!=''">
            AND x.SHORTNAME LIKE CONCAT('%',#{shortName},'%')
        </if>
        <if test="proxyName != null and proxyName!=''">
            AND b.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <if test="proxyName1 != null and proxyName1!=''">
            AND b.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
        </if>
        <if test="businessOrderNo != null and businessOrderNo!=''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="sn != null and sn!=''">
            AND a.sn = #{sn}
        </if>
        <if test="markCode != null and markCode!=''">
            AND b.mark_code = #{markCode}
        </if>
        <if test="globalId != null and globalId!=''">
            AND x.GLOBALID = #{globalId}
        </if>
        <if test="appId != null and appId!=''">
            AND a.app_id = #{appId}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        <if test="payChannelSign != null and payChannelSign > 0">
            AND a.pay_channel_sign = #{payChannelSign}
        </if>
    </select>

    <!-- 统计 -->
    <select id="amountCount"  resultType="java.lang.String">
        SELECT
        SUM(a.trade_amount)
        FROM
        tb_order a
        LEFT JOIN tb_merchant_info b ON a.payee = b.account_id
        WHERE
        a.trade_type = 1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name LIKE CONCAT('%',#{merchantName},'%')
        </if>
        <if test="proxyName != null and proxyName!=''">
            AND b.first_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName},'%'))
        </if>
        <if test="proxyName1 != null and proxyName1!=''">
            AND b.second_dealer_id in (select id from tb_dealer where proxy_name LIKE CONCAT('%',#{proxyName1},'%'))
        </if>
        <if test="businessOrderNo != null and businessOrderNo!=''">
            AND a.business_order_no = #{businessOrderNo}
        </if>
        <if test="sn != null and sn!=''">
            AND a.sn = #{sn}
        </if>
        <if test="markCode != null and markCode!=''">
            AND b.mark_code = #{markCode}
        </if>
        <if test="appId != null and appId!=''">
            AND a.app_id = #{appId}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type LIKE CONCAT('%',#{payType},'%')
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        <if test="payChannelSign != null and payChannelSign > 0">
            AND a.pay_channel_sign = #{payChannelSign}
        </if>
    </select>



    <!--查询商户详情  -->
    <select id="getMerchantAll" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
            id,
            merchant_name,
            dealer_id,
            account_id,
            bank_no,
            name,
            mobile,
            reserve_mobile,
            create_time,
            identity
        FROM
            tb_merchant_info
        WHERE
            account_id = #{payee}
    </select>

    <!--查询代理商详情-->
    <select id="getDealerAll" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        proxy_name,
        first_level_dealer_id,
        LEVEL
        FROM
        tb_dealer
        WHERE
        id = #{dealerId}
    </select>

    <select id="getProxyName" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id = #{firstLevelDealerId}
    </select>

    <select id="getProxyName1" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id = #{firstLevelDealerId}
    </select>

    <select id="selectByOrderNo" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE order_no = #{orderNo}
    </select>
    
    <select id="selectMerchantPayOrders" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order
        WHERE trade_type = 1
        AND payee = #{accountId}
        <if test="orderNo != null">
            AND order_no = #{orderNo}
        </if>
        <if test="payType != null">
            AND pay_channel_sign IN
            <foreach collection="payType" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="payStatus != null">
            AND status IN
            <foreach collection="payStatus" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="startDate != null">
            AND create_time BETWEEN #{startDate} AND #{endDate}
        </if>
        ORDER BY id DESC LIMIT #{offset}, #{count}
    </select>

    <select id="selectCountMerchantPayOrders" resultType="java.lang.Long">
        SELECT COUNT(0) FROM tb_order
        WHERE trade_type = 1
        AND payee = #{accountId}
        <if test="orderNo != null">
            AND order_no = #{orderNo}
        </if>
        <if test="payType != null">
            AND pay_channel_sign IN
            <foreach collection="payType" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="payStatus != null">
            AND status IN
            <foreach collection="payStatus" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="startDate != null">
            AND create_time BETWEEN #{startDate} AND #{endDate}
        </if>
    </select>

    <select id="selectByBusinessOrderNo" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE business_order_no = #{businessOrderNo}
    </select>

    <select id="selectTotalTradeAmountByAccountId" resultType="java.math.BigDecimal">
        SELECT SUM(trade_amount) FROM tb_order WHERE app_id = #{appId} AND payee = #{accountId} AND service_type = #{serviceType} AND trade_type = 1
    </select>

    <select id="selectCheckedOrderNosByOrderNos" resultType="java.lang.String">
        SELECT order_no FROM tb_order
        WHERE order_no IN
        <foreach collection="orderNos" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND checked_status = 1
    </select>

    <select id="selectPageOrdersCountByAccountId" resultType="java.lang.Long">
        SELECT COUNT(0) FROM tb_order
        WHERE ((trade_type = 1 and payee = #{accountId}) or (trade_type = 3 and payer = #{accountId}))
        AND app_id = #{appId}
        AND status in (4, 6)
        <if test="date != null">
            AND create_time &lt;= #{date}
        </if>
    </select>

    <select id="selectPageOrdersByAccountId" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order
        WHERE ((trade_type = 1 and payee = #{accountId}) or (trade_type = 3 and payer = #{accountId}))
        AND app_id = #{appId}
        AND status in (4, 6)
        <if test="date != null">
            AND create_time &lt;= #{date}
        </if>
        ORDER BY id DESC
        LIMIT #{offset}, #{count}
    </select>
    <select id="getByOrderNos" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE order_no
        in <foreach collection="orderNos" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
    </select>

    <select id="selectT1PaySuccessAndUnSettleOrderIds" resultType="java.lang.Long">
        SELECT id FROM tb_order
        WHERE app_id = #{appId}
        AND settle_time = #{settleDate}
        AND settle_status = 1
        AND status = 4
        AND settle_type = 'T1'
        AND trade_type = 1
        AND pay_channel_sign IN
        <foreach collection="channelList" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <!-- 查询打款 -->
    <select id="getPlayMoney" resultType="com.jkm.hss.bill.entity.PlayResponse">
        SELECT
            sn,
            amount,
            request_time,
            `status`,
            finish_time,
            play_money_channel,
            message
        FROM
            tb_play_money_order
        WHERE
            order_no = #{orderNo}
    </select>

    <select id="selectTradeAmountAndFeeByOrderNoList" resultType="java.util.Map">
        SELECT SUM(trade_amount) as tradeAmount, SUM(poundage) as poundage FROM tb_order
        WHERE order_no IN
        <foreach collection="orderNos" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectByAppParam" resultType="com.jkm.hss.bill.entity.Order">
        SELECT trade_amount, poundage, pay_channel_sign, create_time FROM tb_order
        WHERE order_no IN
        <foreach collection="orderNos" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        ORDER BY id DESC
        LIMIT #{offset}, #{count}
    </select>
</mapper>