<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.bill.dao.OrderDao">
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_order
        (
        pay_order_id,
        order_no,
        trade_amount,
        real_pay_amount,
        trade_type,
        payer,
        payee,
        pay_account,
        pay_account_type,
        pay_type,
        pay_success_time,
        poundage,
        pay_rate,
        goods_name,
        goods_describe,
        settle_status,
        settle_time,
        success_settle_time,
        pay_channel_sign,
        remark,
        status
        )
        VALUES
        (
        #{payOrderId},
        #{orderNo},
        #{tradeAmount},
        #{realPayAmount},
        #{tradeType},
        #{payer},
        #{payee},
        #{payAccount},
        #{payAccountType},
        #{payType},
        #{paySuccessTime},
        #{poundage},
        #{payRate},
        #{goodsName},
        #{goodsDescribe},
        #{settleStatus},
        #{settleTime},
        #{successSettleTime},
        #{payChannelSign},
        #{remark},
        #{status}
        );
    </insert>

    <update id="update">
        UPDATE tb_order
        SET
        order_no = #{orderNo},
        trade_amount = #{tradeAmount},
        real_pay_amount = #{realPayAmount},
        trade_type = #{tradeType},
        payer = #{payer},
        payee = #{payee},
        pay_account = #{payAccount},
        pay_account_type = #{payAccountType},
        pay_type = #{payType},
        pay_success_time = #{paySuccessTime},
        poundage = #{poundage},
        pay_rate = #{payRate},
        goods_name = #{goodsName},
        goods_describe = #{goodsDescribe},
        settle_status = #{settleStatus},
        settle_time = #{settleTime},
        success_settle_time = #{successSettleTime},
        remark = #{remark},
        status = #{status}
        WHERE id = #{id}
    </update>

    <update id="updateRemark">
        UPDATE tb_order SET remark = #{remark} WHERE id = #{id}
    </update>

    <update id="updateStatus">
        UPDATE tb_order SET status = #{status}, remark = #{remark} WHERE id = #{id}
    </update>

    <update id="updateSettleStatus">
        UPDATE tb_order SET settle_status = #{status}, success_settle_time = NOW() WHERE id = #{id}
    </update>

    <update id="markSettleSuccess">
        UPDATE tb_order SET settle_status = #{status}, success_settle_time = #{successSettleTime} WHERE id = #{id}
    </update>

    <select id="selectById" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE id = #{id}
    </select>

    <select id="selectByIdWithLock" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE id = #{id} FOR UPDATE
    </select>

    <select id="selectByOrderNoAndTradeType" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE order_no = #{orderNo} AND trade_type = #{tradeType};
    </select>

    <select id="selectByPayOrderId" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE pay_order_id = #{payOrderId} AND trade_type = 3;
    </select>

    <select id="selectOrderList" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        a.pay_order_id,
        a.order_no,
        a.trade_amount,
        a.real_pay_amount,
        a.trade_type,
        a.payer,
        a.payee,
        a.pay_account,
        a.pay_account_type,
        a.pay_type,
        a.pay_success_time,
        a.poundage,
        a.pay_rate,
        a.settle_status,
        a.settle_time,
        a.success_settle_time,
        a.pay_channel_sign,
        a.remark,
        a. STATUS,
        a.create_time,
        b.merchant_name,
        (
        SELECT
        c.proxy_name
        FROM
        tb_dealer c
        WHERE
        c.id = b.dealer_id
        ) AS proxyName,
        (
        SELECT
        c. LEVEL
        FROM
        tb_dealer c
        WHERE
        c.id = b.dealer_id
        ) AS LEVEL,
        (
        SELECT
        c.first_level_dealer_id
        FROM
        tb_dealer c
        WHERE
        c.id = b.dealer_id
        ) AS firstLevelDealerId
        FROM
        tb_order a
        LEFT JOIN tb_merchant_info b
        ON a.payee=b.account_id
        WHERE a.trade_type=1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name = #{merchantName}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type =  #{payType}
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        ORDER BY a.create_time DESC
        limit #{offset}, #{size}
    </select>

    <!-- 交易详情 -->
    <select id="selectOrderListByPageAll" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
            pay_order_id,
            order_no,
            trade_amount,
            real_pay_amount,
            trade_type,
            payer,
            payee,
            pay_account,
            pay_account_type,
            pay_type,
            pay_success_time,
            poundage,
            pay_rate,
            settle_status,
            settle_time,
            success_settle_time,
            pay_channel_sign,
            remark,
            status,
            create_time
        FROM
            tb_order
        WHERE
            order_no = #{orderNo}
        ORDER BY
            create_time DESC
    </select>

    <!--查询生成ExcelVo 导出excel-->
    <select id="selectOrderListTrade" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        a.pay_order_id,
        a.order_no,
        a.trade_amount,
        a.real_pay_amount,
        a.trade_type,
        a.payer,
        a.payee,
        a.pay_account,
        a.pay_account_type,
        a.pay_type,
        a.pay_success_time,
        a.poundage,
        a.pay_rate,
        a.settle_status,
        a.settle_time,
        a.success_settle_time,
        a.pay_channel_sign,
        a.remark,
        a. STATUS,
        a.create_time,
        b.merchant_name,
        (
        SELECT
        c.proxy_name
        FROM
        tb_dealer c
        WHERE
        c.id = b.dealer_id
        ) AS proxyName,
        (
        SELECT
        c. LEVEL
        FROM
        tb_dealer c
        WHERE
        c.id = b.dealer_id
        ) AS LEVEL,
        (
        SELECT
        c.first_level_dealer_id
        FROM
        tb_dealer c
        WHERE
        c.id = b.dealer_id
        ) AS firstLevelDealerId
        FROM
        tb_order a
        LEFT JOIN tb_merchant_info b
        ON a.payee=b.account_id
        WHERE a.trade_type=1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name = #{merchantName}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type =  #{payType}
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <select id="selectOrderListCount"  resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM
        tb_order a
        LEFT JOIN tb_merchant_info b
        ON a.payee=b.account_id
        WHERE a.trade_type=1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no LIKE CONCAT('%',#{orderNo})
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name = #{merchantName}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type =  #{payType}
        </if>
        <if test="lessTotalFee != null and lessTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ >= ]]> #{lessTotalFee}
        </if>
        <if test="moreTotalFee != null and moreTotalFee!=''">
            AND a.real_pay_amount <![CDATA[ <= ]]> #{moreTotalFee}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
    </select>

    <!--查询商户详情  -->
    <select id="getMerchantAll" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
            id,
            merchant_name,
            dealer_id,
            account_id,
            bank_no,
            name,
            mobile,
            reserve_mobile,
            create_time,
            identity
        FROM
            tb_merchant_info
        WHERE
            account_id = #{payee}
    </select>

    <!--查询代理商详情-->
    <select id="getDealerAll" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        proxy_name,
        first_level_dealer_id,
        LEVEL
        FROM
        tb_dealer
        WHERE
        id = #{dealerId}
    </select>

    <select id="getProxyName" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id = #{firstLevelDealerId}
    </select>

    <select id="getProxyName1" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id = #{firstLevelDealerId}
    </select>

    <select id="selectByOrderNo" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE order_no = #{orderNo}
    </select>
    
    <select id="selectMerchantPayOrders" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order
        WHERE trade_type = 1
        <if test="orderNo != null">
            AND order_no = #{orderNo}
        </if>
        <if test="payType != null">
            AND pay_type = #{payType}
        </if>
        <if test="payStatus > 0">
            AND status = #{payStatus}
        </if>
        <if test="startDate != null">
            AND create_time BETWEEN #{startDate} AND #{endDate}
        </if>
        ORDER BY id DESC LIMIT #{offset}, #{count}
    </select>

    <select id="selectCountMerchantPayOrders" resultType="java.lang.Long">
        SELECT COUNT(0) FROM tb_order
        WHERE trade_type = 1
        <if test="orderNo != null">
            AND order_no = #{orderNo}
        </if>
        <if test="payType != null">
            AND pay_type = #{payType}
        </if>
        <if test="payStatus > 0">
            AND status = #{payStatus}
        </if>
        <if test="startDate != null">
            AND create_time BETWEEN #{startDate} AND #{endDate}
        </if>
    </select>
</mapper>