<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.bill.dao.OrderDao">
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_order
        (
        pay_order_id,
        order_no,
        trade_amount,
        real_pay_amount,
        trade_type,
        payer,
        payee,
        pay_account,
        pay_account_type,
        pay_type,
        pay_success_time,
        poundage,
        pay_rate,
        goods_name,
        goods_describe,
        settle_status,
        settle_time,
        success_settle_time,
        pay_channel_sign,
        remark,
        status
        )
        VALUES
        (
        #{payOrderId},
        #{orderNo},
        #{tradeAmount},
        #{realPayAmount},
        #{tradeType},
        #{payer},
        #{payee},
        #{payAccount},
        #{payAccountType},
        #{payType},
        #{paySuccessTime},
        #{poundage},
        #{payRate},
        #{goodsName},
        #{goodsDescribe},
        #{settleStatus},
        #{settleTime},
        #{successSettleTime},
        #{payChannelSign},
        #{remark},
        #{status}
        );
    </insert>

    <update id="update">
        UPDATE tb_order
        SET
        order_no = #{orderNo},
        trade_amount = #{tradeAmount},
        real_pay_amount = #{realPayAmount},
        trade_type = #{tradeType},
        payer = #{payer},
        payee = #{payee},
        pay_account = #{payAccount},
        pay_account_type = #{payAccountType},
        pay_type = #{payType},
        pay_success_time = #{paySuccessTime},
        poundage = #{poundage},
        pay_rate = #{payRate},
        goods_name = #{goodsName},
        goods_describe = #{goodsDescribe},
        settle_status = #{settleStatus},
        settle_time = #{settleTime},
        success_settle_time = #{successSettleTime},
        remark = #{remark},
        status = #{status}
        WHERE id = #{id}
    </update>

    <update id="updateRemark">
        UPDATE tb_order SET remark = #{remark} WHERE id = #{id}
    </update>

    <update id="updateStatus">
        UPDATE tb_order SET status = #{status}, remark = #{remark} WHERE id = #{id}
    </update>

    <update id="updateSettleStatus">
        UPDATE tb_order SET settle_status = #{status} WHERE id = #{id}
    </update>

    <update id="markSettleSuccess">
        UPDATE tb_order SET settle_status = #{status}, success_settle_time = #{successSettleTime} WHERE id = #{id}
    </update>

    <select id="selectById" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE id = #{id}
    </select>

    <select id="selectByIdWithLock" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE id = #{id} FOR UPDATE
    </select>

    <select id="selectByOrderNoAndTradeType" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE order_no = #{orderNo} AND trade_type = #{tradeType};
    </select>

    <select id="selectByPayOrderId" resultType="com.jkm.hss.bill.entity.Order">
        SELECT * FROM tb_order WHERE pay_order_id = #{payOrderId} AND trade_type = 3;
    </select>

    <select id="selectOrderList" resultType="com.jkm.hss.bill.entity.MerchantTradeResponse">
        SELECT
            a.pay_order_id,
            a.order_no,
            a.trade_amount,
            a.real_pay_amount,
            a.trade_type,
            a.payer,
            a.payee,
            a.pay_account,
            a.pay_account_type,
            a.pay_type,
            a.pay_success_time,
            a.poundage,
            a.pay_rate,
            a.settle_status,
            a.settle_time,
            a.success_settle_time,
            a.pay_channel_sign,
            a.remark,
            a.status,
            a.create_time,
            b.id,
            b.dealer_id,
            b.merchant_name
        FROM
            tb_order a
        LEFT JOIN tb_merchant_info b
        ON a.payer=b.account_id
        WHERE 1=1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no = #{orderNo}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name = #{merchantName}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type =  #{payType}
        </if>
        <if test="realPayAmount != null and realPayAmount!=''">
            AND a.real_pay_amount = #{realPayAmount}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
        ORDER BY o.create_time DESC
        limit #{offset}, #{size}
    </select>

    <select id="selectOrderListCount"  resultType="java.lang.Integer">
        SELECT COUNT(1)
		FROM tb_order a
		LEFT JOIN tb_merchant_info b
		ON a.payer=b.account_id
        WHERE 1=1
        <if test="startTime!=null and startTime!=''">
            AND a.create_time <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND a.create_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="orderNo != null and orderNo!=''">
            AND a.order_no = #{orderNo}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND b.merchant_name = #{merchantName}
        </if>
        <if test="status != null and status!=''">
            AND a.status=#{status}
        </if>
        <if test="payType != null and payType!=''">
            AND a.pay_type =  #{payType}
        </if>
        <if test="realPayAmount != null and realPayAmount!=''">
            AND a.real_pay_amount = #{realPayAmount}
        </if>
        <if test="settleStatus != null">
            AND a.settle_status = #{settleStatus}
        </if>
    </select>

    <!--<select id="selectOrderListCount" resultType="com.jkm.hss.bill.entity.Order">-->
        <!--SELECT * FROM tb_order-->
    <!--</select>-->

    <!--<select id="selectOrderListCountAll" resultType="com.jkm.hss.bill.entity.Order">-->
        <!--SELECT * FROM tb_order-->
    <!--</select>-->

</mapper>