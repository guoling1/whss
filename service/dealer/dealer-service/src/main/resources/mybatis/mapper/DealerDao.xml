<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.dealer.dao.DealerDao">
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_dealer
        (
        account_id,
        mobile,
        proxy_name,
        bank_account_name,
        bank_name,
        settle_bank_card,
        bank_reserve_mobile,
        belong_area,
        level,
        first_level_dealer_id,
        second_level_dealer_id,
        last_login_date,
        status,
        recommend_btn,
        id_card,
        total_profit_space,
        belong_province_code,
        belong_province_name,
        belong_city_code,
        belong_city_name,
        invite_code,
        invite_btn
        )
        VALUES
        (
        #{accountId},
        #{mobile},
        #{proxyName},
        #{bankAccountName},
        #{bankName},
        #{settleBankCard},
        #{bankReserveMobile},
        #{belongArea},
        #{level},
        #{firstLevelDealerId},
        #{secondLevelDealerId},
        #{lastLoginDate},
        #{status},
        #{recommendBtn},
        #{idCard},
        #{totalProfitSpace},
        #{belongProvinceCode},
        #{belongProvinceName},
        #{belongCityCode},
        #{belongCityName},
        #{inviteCode},
        #{inviteBtn}
        );
    </insert>
    <update id="update">
        UPDATE tb_dealer
        SET
        account_id = #{accountId},
        mobile = #{mobile},
        proxy_name = #{proxyName},
        bank_account_name = #{bankAccountName},
        settle_bank_card = #{settleBankCard},
        bank_reserve_mobile = #{bankReserveMobile},
        belong_area = #{belongArea},
        level = #{level},
        first_level_dealer_id = #{firstLevelDealerId},
        second_level_dealer_id = #{secondLevelDealerId},
        last_login_date = #{lastLoginDate},
        status = #{status},
        recommend_btn = #{recommendBtn},
        id_card = #{idCard},
        total_profit_space = #{totalProfitSpace}
        WHERE id = #{id}
    </update>

    <update id="updateLoginDate">
        UPDATE tb_dealer SET last_login_date = NOW() WHERE id = #{dealerId}
    </update>

    <select id="selectById" resultType="com.jkm.hss.dealer.entity.Dealer">
        SELECT * FROM tb_dealer WHERE id = #{id}
    </select>

    <select id="selectByIds" resultType="com.jkm.hss.dealer.entity.Dealer">
         SELECT * FROM tb_dealer
         WHERE id IN
         <foreach collection="ids" index="index" item="item" open="(" separator="," close=")">
             #{item}
         </foreach>
    </select>

    <select id="selectByAccountId" resultType="com.jkm.hss.dealer.entity.Dealer">
        SELECT * FROM tb_dealer WHERE account_id = #{accountId}
    </select>

    <select id="selectByMobile" resultType="com.jkm.hss.dealer.entity.Dealer">
        SELECT * FROM tb_dealer WHERE mobile = #{mobile}
    </select>

    <select id="selectByMobileUnIncludeNow" resultType="com.jkm.hss.dealer.entity.Dealer">
         SELECT * FROM tb_dealer WHERE mobile = #{mobile} AND id != #{dealerId}
    </select>

    <select id="selectAllFirstLevelDealers" resultType="com.jkm.hss.dealer.entity.Dealer">
        SELECT * FROM tb_dealer WHERE level = 1
    </select>

    <select id="selectSecondLevelDealersByFirstLevelDealerId" resultType="com.jkm.hss.dealer.entity.Dealer">
        SELECT * FROM tb_dealer WHERE first_level_dealer_id = #{firstLevelDealerId} AND level = 2
    </select>

    <select id="selectThirdLevelDealersBySecondLevelDealerId" resultType="com.jkm.hss.dealer.entity.Dealer">
        SELECT * FROM tb_dealer WHERE second_level_dealer_id = #{secondLevelDealerId} AND level = 3
    </select>

    <select id="selectByProxyName" resultType="java.lang.Long">
         SELECT COUNT(1) FROM tb_dealer WHERE proxy_name = #{name}
    </select>

    <select id="selectByProxyNameUnIncludeNow" resultType="java.lang.Long">
        SELECT COUNT(1) FROM tb_dealer WHERE proxy_name = #{proxyMame} AND id != #{dealerId}
    </select>

    <select id="selectByCondition" resultType="com.jkm.hss.dealer.entity.Dealer">
        SELECT id, mobile, proxy_name FROM tb_dealer
        WHERE (mobile LIKE "%"#{condition}"%" OR proxy_name LIKE "%"#{condition}"%")
        <if test="dealerId > 0">
            AND first_level_dealer_id = #{dealerId}
        </if>
        AND level = #{level}
    </select>

    <select id="selectMyDealerCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM tb_dealer WHERE first_level_dealer_id = #{firstDealerId} AND level = 2
    </select>

    <select id="selectDealerCountByPageParams" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM tb_dealer
        <where>
            <if test="id > 0">
                AND id = ${id}
            </if>
            <if test="name != null">
                AND `proxy_name` LIKE "%"#{name}"%"
            </if>
            <if test="mobile != null">
                AND mobile = #{mobile}
            </if>
            <if test="belongArea != null">
                AND belong_area LIKE "%"#{belongArea}"%"
            </if>
            <if test="level > 0">
                AND level = #{level}
            </if>
        </where>
    </select>

    <select id="selectDealersByPageParams" resultType="com.jkm.hss.dealer.entity.Dealer">
        SELECT * FROM tb_dealer
        <where>1=1
            <if test="id > 0">
                AND id = ${id}
            </if>
            <if test="name != null">
                AND `proxy_name` LIKE "%"#{name}"%"
            </if>
            <if test="mobile != null">
                AND mobile = #{mobile}
            </if>
            <if test="belongArea != null">
                AND belong_area LIKE "%"#{belongArea}"%"
            </if>
            <if test="level > 0">
                AND level = #{level}
            </if>
            <if test="bankReserveMobile!=null and bankReserveMobile!=''">
                AND bank_reserve_mobile=#{bankReserveMobile}
            </if>
            <if test="settleBankCard!=null and settleBankCard!=''">
                AND settle_bank_card=#{settleBankCard}
            </if>
            ORDER BY id DESC LIMIT #{offset},#{count}
        </where>
    </select>

    <update id="updateMarkCode">
        UPDATE tb_dealer SET mark_code = #{markCode} WHERE id = #{dealerId}
    </update>




    <select id="selectFirstDealerCountByPageParams" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM tb_dealer as d
        <where>
            d.level = 1
            <if test="mobile!=null and mobile!=''">
                AND d.mobile =#{mobile}
            </if>
            <if test="name != null and name!=''">
                AND d.`proxy_name` LIKE "%"#{name}"%"
            </if>
            <if test="markCode != null and markCode!=''">
                AND d.mark_code = #{markCode}
            </if>
            <if test="districtCode != null and districtCode!=''">
                AND (d.belong_province_code = #{districtCode} OR d.belong_city_code=#{districtCode})
            </if>
            <if test="sysType != null and sysType!=''">
                AND d.id IN (select distinct(dealer_id) from tb_dealer_channel_rate where product_id in (select id from tb_product where type=#{sysType}))
            </if>
        </where>
    </select>

    <select id="selectFirstDealersByPageParams" resultType="com.jkm.hss.dealer.helper.response.FirstDealerResponse">
        SELECT
        d.id,
        d.proxy_name,
        d.mark_code,
        d.level,
        d.create_time,
        d.bank_account_name,
        d.belong_province_code,
        d.belong_province_name,
        d.belong_city_code,
        d.belong_city_name,
        (
        SELECT DISTINCT
        (product_id)
        FROM
        tb_dealer_channel_rate
        WHERE
        dealer_id = d.id
        AND product_id IN (
        SELECT
        id
        FROM
        tb_product
        WHERE
        type = 'hss'
        )
        ) AS hss_product_id,
        (
        SELECT DISTINCT
        (product_id)
        FROM
        tb_dealer_channel_rate
        WHERE
        dealer_id = d.id
        AND product_id IN (
        SELECT
        id
        FROM
        tb_product
        WHERE
        type = 'hsy'
        )
        ) AS hsy_product_id,
        d.mobile
        FROM tb_dealer as d
        <where>
            d.level = 1
            <if test="mobile!=null and mobile!=''">
                AND d.mobile =#{mobile}
            </if>
            <if test="name != null and name!=''">
                AND d.`proxy_name` LIKE "%"#{name}"%"
            </if>
            <if test="markCode != null and markCode!=''">
                AND d.mark_code = #{markCode}
            </if>
            <if test="districtCode != null and districtCode!=''">
                AND (d.belong_province_code = #{districtCode} OR d.belong_city_code=#{districtCode})
            </if>
            <if test="sysType != null and sysType!=''">
                AND d.id IN (select distinct(dealer_id) from tb_dealer_channel_rate where product_id in (select id from tb_product where type=#{sysType}))
            </if>
            ORDER BY d.create_time ASC LIMIT #{offset},#{count}
        </where>
    </select>


    <select id="selectSecondDealerCountByPageParams" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM tb_dealer as d
        <where>
            d.level = 2
            <if test="mobile!=null and mobile!=''">
                AND d.mobile =#{mobile}
            </if>
            <if test="name != null and name!=''">
                AND d.`proxy_name` LIKE "%"#{name}"%"
            </if>
            <if test="markCode != null and markCode!=''">
                AND d.mark_code = #{markCode}
            </if>
            <if test="districtCode != null and districtCode!=''">
                AND (d.belong_province_code = #{districtCode} OR d.belong_city_code=#{districtCode})
            </if>
            <if test="sysType != null and sysType!=''">
                AND d.id IN (select distinct(dealer_id) from tb_dealer_channel_rate where product_id in (select id from tb_product where type=#{sysType}))
            </if>
            <if test="firstDealerName != null and firstDealerName!=''">
                AND d.first_level_dealer_id IN (select id from tb_dealer where `proxy_name` LIKE "%"#{firstDealerName}"%")
            </if>
        </where>
    </select>

    <select id="selectSecondDealersByPageParams" resultType="com.jkm.hss.dealer.helper.response.SecondDealerResponse">
        SELECT
        d.id,
        d.proxy_name,
        d.mark_code,
        d.level,
        d.create_time,
        d.bank_account_name,
        d.belong_province_code,
        d.belong_province_name,
        d.belong_city_code,
        d.belong_city_name,
        (
        SELECT DISTINCT
        (product_id)
        FROM
        tb_dealer_channel_rate
        WHERE
        dealer_id = d.id
        AND product_id IN (
        SELECT
        id
        FROM
        tb_product
        WHERE
        type = 'hss'
        )
        ) AS hss_product_id,
        (
        SELECT DISTINCT
        (product_id)
        FROM
        tb_dealer_channel_rate
        WHERE
        dealer_id = d.id
        AND product_id IN (
        SELECT
        id
        FROM
        tb_product
        WHERE
        type = 'hsy'
        )
        ) AS hsy_product_id,
        (select proxy_name from tb_dealer WHERE id =d.first_level_dealer_id) as first_proxy_name,
        d.mobile
        FROM tb_dealer as d
        <where>
            d.level = 2
            <if test="mobile!=null and mobile!=''">
                AND d.mobile =#{mobile}
            </if>
            <if test="name != null and name!=''">
                AND d.`proxy_name` LIKE "%"#{name}"%"
            </if>
            <if test="markCode != null and markCode!=''">
                AND d.mark_code = #{markCode}
            </if>
            <if test="districtCode != null and districtCode!=''">
                AND (d.belong_province_code = #{districtCode} OR d.belong_city_code=#{districtCode})
            </if>
            <if test="sysType != null and sysType!=''">
                AND d.id IN (select distinct(dealer_id) from tb_dealer_channel_rate where product_id in (select id from tb_product where type=#{sysType}))
            </if>
            <if test="firstDealerName != null and firstDealerName!=''">
                AND d.first_level_dealer_id IN (select id from tb_dealer where `proxy_name` LIKE "%"#{firstDealerName}"%")
            </if>
            ORDER BY d.create_time ASC LIMIT #{offset},#{count}
        </where>
    </select>



    <update id="updateMarkCodeAndInviteCode">
        UPDATE tb_dealer SET mark_code = #{markCode},invite_code=#{inviteCode} WHERE id = #{dealerId}
    </update>

    <update id="update2">
        UPDATE tb_dealer
        SET
        mobile = #{mobile},
        proxy_name = #{proxyName},
        belong_province_code=#{belongProvinceCode},
        belong_province_name=#{belongProvinceName},
        belong_city_code=#{belongCityCode},
        belong_city_name=#{belongCityName},
        belong_area = #{belongArea},
        settle_bank_card = #{settleBankCard},
        bank_name = #{bankName},
        bank_account_name = #{bankAccountName},
        id_card = #{idCard},
        bank_reserve_mobile = #{bankReserveMobile}
        WHERE id = #{id}
    </update>
</mapper>