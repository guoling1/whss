<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.admin.dao.QRCodeDao">
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
      INSERT INTO tb_qr_code
      (
      code,
      admin_id,
      first_level_dealer_id,
      second_level_dealer_id,
      merchant_id,
      salt,
      sign,
      distribute_status,
      activate_status,
      type,
      product_id,
      sys_type,
      qr_type,
      activate_time,
      distribute_time
      )
      VALUES
      (
      #{code},
      #{adminId},
      #{firstLevelDealerId},
      #{secondLevelDealerId},
      #{merchantId},
      #{salt},
      #{sign},
      #{distributeStatus},
      #{activateStatus},
      #{type},
      #{productId},
      #{sysType},
      #{qrType},
      #{activateTime},
      #{distributeTime}
      );
    </insert>

    <update id="updateById">
        UPDATE tb_qr_code
        SET
        code = #{code},
        admin_id = #{adminId},
        first_level_dealer_id = #{firstLevelDealerId},
        second_level_dealer_id = #{secondLevelDealerId},
        merchant_id = #{merchantId},
        salt = #{salt},
        sign = #{sign},
        distribute_status = #{distributeStatus},
        activate_status = #{activateStatus},
        type = #{type}
        WHERE id = #{id}
    </update>

    <update id="updateByCode">
        UPDATE tb_qr_code
        SET
        admin_id = #{adminId},
        first_level_dealer_id = #{firstLevelDealerId},
        second_level_dealer_id = #{secondLevelDealerId},
        merchant_id = #{merchantId},
        salt = #{salt},
        sign = #{sign},
        distribute_status = #{distributeStatus},
        activate_status = #{activateStatus},
        type = #{type}
        WHERE code = #{code}
    </update>

    <update id="markCodeToDealer">
        UPDATE tb_qr_code
        SET first_level_dealer_id = #{firstLevelDealerId}
        WHERE first_level_dealer_id =0
        AND second_level_dealer_id = 0
        AND distribute_status = 1
        AND activate_status = 1
        AND  id IN
        <foreach collection="codeIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="markCodeToDealerByRange">
        UPDATE tb_qr_code
        SET first_level_dealer_id = #{firstLevelDealerId}
        WHERE first_level_dealer_id =0
        AND second_level_dealer_id = 0
        AND distribute_status = 1
        AND activate_status = 1
        AND code BETWEEN #{startCode} AND #{endCode}
    </update>

    <update id="markAsDistribute">
        UPDATE tb_qr_code
        SET distribute_status = 2
        WHERE id IN
        <foreach collection="codeIds" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="markAsDistribute2">
        UPDATE tb_qr_code
        SET distribute_status = 2,
        distribute_time=now(),
        second_level_dealer_id = #{toDealerId}
        WHERE id IN
        <foreach collection="codeIds" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="markAsActivate">
        UPDATE tb_qr_code
        SET
        merchant_id = #{merchantId},
        activate_time=now(),
        distribute_status = 2,
        activate_status = 2
        WHERE code = #{code}
    </update>

    <update id="test">
        UPDATE tb_qr_code
        SET distribute_status = 1
        WHERE code BETWEEN #{startCode} AND #{endCode}
    </update>

    <select id="selectById" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code WHERE id = #{id}
    </select>

    <select id="selectByIds" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code
        WHERE id IN
        <foreach collection="codeIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectByCode" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code WHERE code = #{code}
    </select>

    <select id="selectByMerchantId" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code WHERE merchant_id = #{merchantId}
    </select>

    <select id="selectByMerchantIds" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code
        WHERE merchant_id IN
        <foreach collection="ids" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectFirstLevelDealerCodeByDealerId" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code WHERE first_level_dealer_id = #{firstLevelDealerId} AND status = #{status}
    </select>

    <select id="selectSecondLevelDealerCodeByDealerId" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code WHERE second_level_dealer_id = #{secondLevelDealerId} AND status = #{status}
    </select>

    <select id="selectLatestQRCodeForUpdate" resultType="com.jkm.hss.admin.entity.QRCode">
         SELECT * FROM tb_qr_code ORDER BY code DESC LIMIT 1 FOR UPDATE
    </select>


    <select id="selectUnDistributeCodeCountByFirstLevelDealerId" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code WHERE first_level_dealer_id = #{dealerId} AND distribute_status = 1
    </select>

    <select id="selectUnDistributeCodeByFirstLevelDealerId" resultType="com.jkm.hss.admin.entity.QRCode">
         SELECT * FROM tb_qr_code
         WHERE first_level_dealer_id = #{dealerId}
         AND distribute_status = 1
         AND activate_status = 1
         ORDER BY code ASC
    </select>

    <select id="selectUnDistributeCodeCountByDealerIdAndRangeCode" resultType="java.lang.Integer">
        SELECT COUNT(0) FROM tb_qr_code
        WHERE first_level_dealer_id = #{dealerId}
        AND distribute_status = 1
        AND activate_status = 1
        AND code BETWEEN #{startCode} AND #{endCode}
    </select>

    <select id="selectUnDistributeCodeByDealerIdAndRangeCode" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code
        WHERE first_level_dealer_id = #{dealerId}
        AND distribute_status = 1
        AND activate_status = 1
        AND code BETWEEN #{startCode} AND #{endCode}
        ORDER BY code ASC
    </select>

    <select id="selectDistributeCodeCount" resultType="com.jkm.hss.admin.helper.responseparam.DistributeCodeCount">
        SELECT second_level_dealer_id, COUNT(id) AS count FROM tb_qr_code
        WHERE first_level_dealer_id = #{dealerId}
        AND second_level_dealer_id IN
        <foreach collection="secondLevelDealerIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND distribute_status = 2
        GROUP BY second_level_dealer_id
        ORDER BY second_level_dealer_id DESC
    </select>

    <select id="selectActiveCodeCount" resultType="com.jkm.hss.admin.helper.responseparam.ActiveCodeCount">
        SELECT second_level_dealer_id, COUNT(id) AS count FROM tb_qr_code
        WHERE first_level_dealer_id = #{dealerId}
        AND second_level_dealer_id IN
        <foreach collection="secondLevelDealerIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND distribute_status = 2
        AND activate_status = 2
        GROUP BY second_level_dealer_id
        ORDER BY second_level_dealer_id DESC
    </select>

    <select id="selectFirstLastDayActivateCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE first_level_dealer_id = #{firstLevelDealerId}
        AND activate_status = 2 AND update_time BETWEEN #{startDate} AND #{endDate}
    </select>


    <select id="selectSecondLastDayActivateCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE second_level_dealer_id = #{secondLevelDealerId}
        AND activate_status = 2 AND update_time BETWEEN #{startDate} AND #{endDate}
    </select>

    <select id="getFirstResidueCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE first_level_dealer_id = #{firstLevelDealerId}
        AND distribute_status = 1 AND sys_type=#{sysType}
    </select>

    <select id="getFirstDistributeCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE first_level_dealer_id = #{firstLevelDealerId}
        AND distribute_status = 2 AND sys_type=#{sysType}
    </select>

    <select id="getFirstDistributeToSelfCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE first_level_dealer_id = #{firstLevelDealerId}
        AND second_level_dealer_id = 0
        AND distribute_status = 2 AND sys_type=#{sysType}
    </select>

    <select id="getFirstUnActivateCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE first_level_dealer_id = #{firstLevelDealerId}
        AND distribute_status = 2
        AND activate_status = 1 AND sys_type=#{sysType}
    </select>

    <select id="getFirstActivateCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE first_level_dealer_id = #{firstLevelDealerId}
        AND distribute_status = 2
        AND activate_status = 2 AND sys_type=#{sysType}
    </select>

    <select id="getSecondCodeCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM tb_qr_code
        WHERE second_level_dealer_id = #{secondLevelDealerId}
    </select>

    <select id="getSecondUnActivateCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM tb_qr_code
        WHERE second_level_dealer_id = #{secondLevelDealerId}
        AND activate_status = 1 AND sys_type=#{sysType}
    </select>

    <select id="getSecondActivateCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM tb_qr_code
        WHERE second_level_dealer_id = #{secondLevelDealerId}
        AND activate_status = 2 AND sys_type=#{sysType}
    </select>

    <select id="selectDistributeToSecondDealerCodeCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE first_level_dealer_id = #{firstLevelDealerId}
        AND second_level_dealer_id > 0
        AND distribute_status = 2
    </select>

    <select id="selectCurrentWeekActivateCodeCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        <where>
            <if test="level == 1">
                AND first_level_dealer_id = #{dealerId}
                AND second_level_dealer_id = 0
                AND distribute_status = 2
                AND activate_status = 2
                AND update_time BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="level == 2">
                AND second_level_dealer_id = #{dealerId}
                AND distribute_status = 2
                AND activate_status = 2
                AND update_time BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
    </select>

    <select id="selectActivateCodeCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        <where>
            <if test="level == 1">
                AND first_level_dealer_id = #{dealerId}
                AND second_level_dealer_id = 0
                AND distribute_status = 2
                AND activate_status = 2
            </if>
            <if test="level == 2">
                AND second_level_dealer_id = #{dealerId}
                AND distribute_status = 2
                AND activate_status = 2
            </if>
        </where>
    </select>

    <select id="getCodeByRange" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code WHERE code BETWEEN #{startCode} AND #{endCode}
    </select>

    <select id="getCode" resultType="com.jkm.hss.admin.entity.CodeQueryResponse">
        SELECT
          first_level_dealer_id,
          second_level_dealer_id,
          merchant_id,
          distribute_status,
          activate_status,
          type
        FROM tb_qr_code
        WHERE code=#{code}
    </select>

    <select id="getProxyName" resultType="com.jkm.hss.admin.entity.CodeQueryResponse">
        SELECT
	      proxy_name
        FROM
            tb_dealer
        WHERE
           id = #{firstLevelDealerId}
    </select>

    <select id="getProxyName1" resultType="com.jkm.hss.admin.entity.CodeQueryResponse">
        SELECT
          proxy_name
        FROM
            tb_dealer b
        WHERE
            id = #{secondLevelDealerId}
    </select>

    <select id="getMerchantName" resultType="com.jkm.hss.admin.entity.CodeQueryResponse">
        SELECT
        merchant_name
        FROM
        tb_merchant_info
        WHERE
        id = #{merchantId}
    </select>

    <select id="selectByIdRange" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code WHERE id BETWEEN #{startId} AND #{endId}
    </select>

    <select id="getUnDistributeCode" resultType="java.lang.Long">
        SELECT id FROM tb_qr_code
        WHERE first_level_dealer_id =0
        AND second_level_dealer_id = 0
        AND distribute_status = 1
        AND activate_status = 1
        And sys_type=#{sysType}
        ORDER BY id ASC
    </select>

    <select id="selectCountByRange" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM tb_qr_code
        WHERE first_level_dealer_id =0
        AND second_level_dealer_id = 0
        AND distribute_status = 1
        AND activate_status = 1
        AND code BETWEEN #{startCode} AND #{endCode}
    </select>

    <select id="selectUnDistributeCodeByRangeCode" resultType="java.lang.Long">
        SELECT id FROM tb_qr_code
        WHERE first_level_dealer_id =0
        AND second_level_dealer_id = 0
        AND distribute_status = 1
        AND activate_status = 1
        AND code BETWEEN #{startCode} AND #{endCode}
        AND sys_type=#{sysType}
    </select>


    <select id="selectByCodeAndSysType" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code WHERE code = #{code} and sys_type=#{sysType}
    </select>



    <select id="bindShopCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM tb_qr_code
        WHERE merchant_id=#{shopId} and sys_type=#{sysType}
    </select>

    <select id="bindShopList" resultType="com.jkm.hss.admin.helper.responseparam.QRCodeList">
        SELECT code,create_time FROM tb_qr_code
        WHERE merchant_id=#{shopId} and sys_type=#{sysType} and status=1
    </select>

    <select id="selectUnDistributeCodeByDealerIdAndRangeCodeAndSysType" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code
        WHERE first_level_dealer_id = #{dealerId}
        AND distribute_status = 1
        AND activate_status = 1
        AND code BETWEEN #{startCode} AND #{endCode} AND sys_type=#{sysType}
        ORDER BY code ASC
    </select>

    <select id="getUnDistributeCodeByDealerIdAndSysType" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code
        WHERE first_level_dealer_id = #{dealerId}
        AND distribute_status = 1
        AND activate_status = 1
        AND  sys_type=#{sysType}
        ORDER BY code ASC
    </select>

    <select id="getUnDistributeCodeBySysType" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code
        WHERE first_level_dealer_id =0
        AND second_level_dealer_id = 0
        AND distribute_status = 1
        AND activate_status = 1
        And sys_type=#{sysType}
        ORDER BY id ASC
    </select>

    <select id="getUnDistributeCountBySysType" resultType="java.lang.Integer">
        SELECT count(1) FROM tb_qr_code
        WHERE first_level_dealer_id =0
        AND second_level_dealer_id = 0
        AND distribute_status = 1
        AND activate_status = 1
        And sys_type=#{sysType}
    </select>

    <select id="getUnDistributeCodeByCodeAndSysType" resultType="com.jkm.hss.admin.entity.QRCode">
        SELECT * FROM tb_qr_code
        WHERE first_level_dealer_id = 0
        AND second_level_dealer_id = 0
        AND distribute_status = 1
        AND activate_status = 1
        AND code BETWEEN #{startCode} AND #{endCode} AND sys_type=#{sysType}
        ORDER BY code ASC
    </select>

    <select id="getHSSQrCodeList" resultType="com.jkm.hss.admin.helper.responseparam.QrCodeListResponse">
        SELECT
	    '好收收' as sysTypeName,
	    c.code,
	    c.activate_time,
        (
            SELECT
                proxy_name
            FROM
                tb_dealer
            WHERE
                id = c.first_level_dealer_id
        ) as firstDealerName,
        (
            SELECT
                proxy_name
            FROM
                tb_dealer
            WHERE
                id = c.second_level_dealer_id
        ) as secondDealerName,
	    i.merchant_name,
	    i.mark_code as merchantMarkCode,
	    CASE
            WHEN i.`status` = 0 THEN
                '待填写资料'
            WHEN i.`status` = 1 THEN
                '资料填写中'
            WHEN i.`status` = 2 THEN
                '待审核'
            WHEN i.`status` = 3 THEN
                '审核通过'
            WHEN i.`status` = 4 THEN
                '审核不通过'
            WHEN i.`status` = 5 THEN
                '禁用'
            WHEN i.`status` = 6 THEN
                '审核通过'
            ELSE
                NULL
            END as merchantStatus,
        NULL as shopName
        FROM
	    tb_qr_code as c
        LEFT JOIN tb_merchant_info AS i ON c.merchant_id = i.id
        WHERE  c.sys_type='hss'
        <if test="code != null and code!=''">
            and c.code = #{code}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND c.merchant_id IN (
            SELECT
            id
            FROM
            tb_merchant_info
            WHERE
            merchant_name LIKE "%"#{merchantName}"%"
            )
        </if>
        <if test="firstDealerName != null and firstDealerName!=''">
            AND c.first_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{firstDealerName}"%"
            )
        </if>
        <if test="secondDealerName != null and secondDealerName!=''">
            AND c.second_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{secondDealerName}"%"
            )
        </if>
        ORDER BY
            c.code DESC
        LIMIT #{offset},#{count}
    </select>


    <select id="getHSSQrCodeCount" resultType="java.lang.Long">
        SELECT count(1) from tb_qr_code
        WHERE sys_type='hss'
        <if test="code != null and code!=''">
            and code = #{code}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND merchant_id IN (
            SELECT
            id
            FROM
            tb_merchant_info
            WHERE
            merchant_name LIKE "%"#{merchantName}"%"
            )
        </if>
        <if test="firstDealerName != null and firstDealerName!=''">
            AND first_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{firstDealerName}"%"
            )
        </if>
        <if test="secondDealerName != null and secondDealerName!=''">
            AND second_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{secondDealerName}"%"
            )
        </if>
    </select>

    <select id="getHSYQrCodeList" resultType="com.jkm.hss.admin.helper.responseparam.QrCodeListResponse">
        SELECT
        '好收银' as sysTypeName,
        c.code,
        c.activate_time,
        (
        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id = c.first_level_dealer_id
        ) as firstDealerName,
        (
        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id = c.second_level_dealer_id
        ) as secondDealerName,
        i.NAME  as merchantName,
        i.GLOBALID as merchantMarkCode,
        CASE
        WHEN i.`STATUS` = 1 THEN
        '正常'
        WHEN i.`STATUS` = 2 THEN
        '审核中'
        WHEN i.`STATUS` = 3 THEN
        '审核失败'
        WHEN i.`STATUS` = 4 THEN
        '已注册'
        WHEN i.`STATUS` = 99 THEN
        '禁用'
        ELSE
        NULL
        END as merchantStatus,
        i.SHORTNAME as shopName
        FROM
        tb_qr_code as c
        LEFT JOIN app_biz_shop as i ON c.merchant_id = i.id
        WHERE c.sys_type='hsy'
        <if test="code != null and code!=''">
            and c.code = #{code}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND c.merchant_id IN (
            SELECT
            id
            FROM
            app_biz_shop
            WHERE
            NAME LIKE "%"#{merchantName}"%"
            )
        </if>
        <if test="firstDealerName != null and firstDealerName!=''">
            AND c.first_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{firstDealerName}"%"
            )
        </if>
        <if test="secondDealerName != null and secondDealerName!=''">
            AND c.second_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{secondDealerName}"%"
            )
        </if>
        ORDER BY
        c.code DESC
        LIMIT #{offset},#{count}
    </select>


    <select id="getHSYQrCodeCount" resultType="java.lang.Long">
        SELECT count(1) from tb_qr_code
        WHERE sys_type='hsy'
        <if test="code != null and code!=''">
            and code = #{code}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND merchant_id IN (
            SELECT
            id
            FROM
            app_biz_shop
            WHERE
            NAME LIKE "%"#{merchantName}"%"
            )
        </if>
        <if test="firstDealerName != null and firstDealerName!=''">
            AND first_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{firstDealerName}"%"
            )
        </if>
        <if test="secondDealerName != null and secondDealerName!=''">
            AND second_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{secondDealerName}"%"
            )
        </if>
    </select>


    <select id="getDealerHSSQrCodeList" resultType="com.jkm.hss.admin.helper.responseparam.MyQrCodeListResponse">
        SELECT
        c.id,
        '好收收' as sysTypeName,
        c.code,
        c.distribute_time,
        c.activate_time,
        (
        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id = c.second_level_dealer_id
        ) as secondDealerName,
        i.merchant_name,
        i.mark_code as merchantMarkCode,
        CASE
        WHEN i.`status` = 0 THEN
        '待填写资料'
        WHEN i.`status` = 1 THEN
        '资料填写中'
        WHEN i.`status` = 2 THEN
        '待审核'
        WHEN i.`status` = 3 THEN
        '审核通过'
        WHEN i.`status` = 4 THEN
        '审核不通过'
        WHEN i.`status` = 5 THEN
        '禁用'
        WHEN i.`status` = 6 THEN
        '审核通过'
        ELSE
        NULL
        END as merchantStatus,
        NULL as shopName
        FROM
        tb_qr_code as c
        LEFT JOIN tb_merchant_info AS i ON c.merchant_id = i.id
        WHERE  c.sys_type='hss'
        <if test="merchantStatusList!=null and merchantStatusList.size()>0">
            AND i.`status` IN
            <foreach collection="merchantStatusList" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="firstDealerId>0">
            AND c.first_level_dealer_id = #{firstDealerId}
        </if>
        <if test="secondDealerId>0">
            AND c.second_level_dealer_id = #{secondDealerId}
        </if>
        <if test="code != null and code!=''">
            and c.code = #{code}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND c.merchant_id IN (
            SELECT
            id
            FROM
            tb_merchant_info
            WHERE
            merchant_name LIKE "%"#{merchantName}"%"
            )
        </if>
        <if test="secondDealerName != null and secondDealerName!=''">
            AND c.second_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{secondDealerName}"%"
            )
        </if>
        <if test="activateStatus>0">
            AND c.activate_status = #{activateStatus}
        </if>
        ORDER BY
        c.code DESC
        LIMIT #{offset},#{count}
    </select>


    <select id="getDealerHSSQrCodeCount" resultType="java.lang.Long">
        SELECT count(1)
        FROM
        tb_qr_code as c
        LEFT JOIN tb_merchant_info AS i ON c.merchant_id = i.id
        WHERE  c.sys_type='hss'
        <if test="merchantStatusList!=null and merchantStatusList.size()>0">
            AND i.`status` IN
            <foreach collection="merchantStatusList" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="firstDealerId>0">
            AND c.first_level_dealer_id = #{firstDealerId}
        </if>
        <if test="secondDealerId>0">
            AND c.second_level_dealer_id = #{secondDealerId}
        </if>
        <if test="code != null and code!=''">
            and c.code = #{code}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND c.merchant_id IN (
            SELECT
            id
            FROM
            tb_merchant_info
            WHERE
            merchant_name LIKE "%"#{merchantName}"%"
            )
        </if>
        <if test="secondDealerName != null and secondDealerName!=''">
            AND c.second_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{secondDealerName}"%"
            )
        </if>
        <if test="activateStatus>0">
            AND c.activate_status = #{activateStatus}
        </if>
    </select>


    <select id="getDealerHSYQrCodeList" resultType="com.jkm.hss.admin.helper.responseparam.MyQrCodeListResponse">
        SELECT
        c.id,
        '好收银' as sysTypeName,
        c.code,
        c.distribute_time,
        c.activate_time,
        (
        SELECT
        proxy_name
        FROM
        tb_dealer
        WHERE
        id = c.second_level_dealer_id
        ) as secondDealerName,
        i.NAME as merchantName,
        i.GLOBALID as merchantMarkCode,
        CASE
        WHEN i.`STATUS` = 1 THEN
        '正常'
        WHEN i.`STATUS` = 2 THEN
        '审核中'
        WHEN i.`STATUS` = 3 THEN
        '审核失败'
        WHEN i.`STATUS` = 4 THEN
        '已注册'
        WHEN i.`STATUS` = 99 THEN
        '禁用'
        ELSE
        NULL
        END as merchantStatus,
        i.SHORTNAME as shopName
        FROM
        tb_qr_code as c
        LEFT JOIN app_biz_shop as i ON c.merchant_id = i.id
        WHERE c.sys_type='hsy'
        <if test="merchantStatusList!=null and merchantStatusList.size()>0">
            AND i.STATUS IN
            <foreach collection="merchantStatusList" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="firstDealerId>0">
            AND c.first_level_dealer_id = #{firstDealerId}
        </if>
        <if test="secondDealerId>0">
            AND c.second_level_dealer_id = #{secondDealerId}
        </if>
        <if test="activateStatus>0">
            AND c.activate_status = #{activateStatus}
        </if>
        <if test="code != null and code!=''">
            and c.code = #{code}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND c.merchant_id IN (
            SELECT
            id
            FROM
            app_biz_shop
            WHERE
            NAME LIKE "%"#{merchantName}"%"
            )
        </if>
        <if test="secondDealerName != null and secondDealerName!=''">
            AND c.second_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{secondDealerName}"%"
            )
        </if>
        ORDER BY
        c.code DESC
        LIMIT #{offset},#{count}
    </select>


    <select id="getDealerHSYQrCodeCount" resultType="java.lang.Long">
        SELECT count(1) FROM tb_qr_code as c
        LEFT JOIN app_biz_shop as i ON c.merchant_id = i.id
        WHERE c.sys_type='hsy'
        <if test="merchantStatusList!=null and merchantStatusList.size()>0">
            AND i.STATUS IN
            <foreach collection="merchantStatusList" item="item" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="firstDealerId>0">
            AND c.first_level_dealer_id = #{firstDealerId}
        </if>
        <if test="secondDealerId>0">
            AND c.second_level_dealer_id = #{secondDealerId}
        </if>
        <if test="activateStatus>0">
            AND c.activate_status = #{activateStatus}
        </if>
        <if test="code != null and code!=''">
            and c.code = #{code}
        </if>
        <if test="merchantName != null and merchantName!=''">
            AND c.merchant_id IN (
            SELECT
            id
            FROM
            app_biz_shop
            WHERE
            NAME LIKE "%"#{merchantName}"%"
            )
        </if>
        <if test="secondDealerName != null and secondDealerName!=''">
            AND c.second_level_dealer_id IN (
            SELECT
            id
            FROM
            tb_dealer
            WHERE
            proxy_name LIKE "%"#{secondDealerName}"%"
            )
        </if>
    </select>
</mapper>