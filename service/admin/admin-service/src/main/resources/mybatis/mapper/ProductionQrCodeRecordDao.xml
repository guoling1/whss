<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jkm.hss.admin.dao.ProductionQrCodeRecordDao">
    <sql id="Base_Column_List">
        id,start_code,end_code,count,qr_type,product_id,sys_type,operator_id,download_url,status,create_time,update_time
    </sql>
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_production_qr_code_record
        (
        start_code,
        end_code,
        count,
        qr_type,
        product_id,
        sys_type,
        operator_id,
        download_url,
        status
        )
        VALUES
        (
        #{startCode},
        #{endCode},
        #{count},
        #{qrType},
        #{productId},
        #{sysType},
        #{operatorId},
        #{downloadUrl},
        #{status}
        );
    </insert>

    <!-- 查询列表 -->
    <select id="selectList" resultType="com.jkm.hss.admin.helper.responseparam.ProductionListResponse">
        SELECT
        r.id,r.create_time,r.start_code,r.end_code,r.count,r.qr_type,r.sys_type,(select username from tb_admin_user WHERE  id=r.operator_id) as operatorName,
        (select proxy_name from tb_dealer where id=(select dealer_id from tb_admin_user where id=r.operator_id)) as subCompanyName
        FROM tb_production_qr_code_record as r
        WHERE 1=1
        <if test="qrType>0">
            AND r.qr_type = #{qrType}
        </if>
        <if test="sysType != null and sysType!=''">
            AND r.sys_type = #{sysType}
        </if>
        <if test="subCompanyName != null and subCompanyName!=''">
            AND r.operator_id in (select u.id from tb_admin_user as u left join tb_dealer as d on u.dealer_id=d.id where d.proxy_name like "%"#{subCompanyName}"%")
        </if>
        ORDER BY r.create_time DESC LIMIT #{offset},#{count}
    </select>

    <!-- 查询个数 -->
    <select id="selectCount" resultType="java.lang.Long">
        SELECT
        count(1)
        FROM tb_production_qr_code_record
        WHERE 1=1
        <if test="qrType>0">
            AND qr_type = #{qrType}
        </if>
        <if test="sysType != null and sysType!=''">
            AND sys_type = #{sysType}
        </if>
    </select>

    <update id="updateDownUrl">
        UPDATE tb_production_qr_code_record
        SET
        download_url = #{downloadUrl}
        WHERE id = #{id}
    </update>
</mapper>