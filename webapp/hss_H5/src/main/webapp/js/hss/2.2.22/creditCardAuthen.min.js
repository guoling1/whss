'use strict';

/**
 * Created by administrator on 2016/12/8.
 */

// 引入浏览器特性处理
var http = _require('http');
var message = _require('message');
var browser = _require('browser');
browser.elastic_touch();

function getQueryString(name) {
  var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
  var r = window.location.search.substr(1).match(reg);
  if (r != null) return unescape(r[2]);
  return null;
}

// 定义变量
var ipt = document.getElementById('ipt');
var submit = document.getElementById('submit');

var layer = document.getElementById('layer');
var cancel = document.getElementById('cancel');

cancel.addEventListener('click', function () {
  window.location.href = '/sqb/wallet';
});

// 定义信用卡号 正确性校验
var test = function test(cardNo) {
  cardNo = cardNo || '';
  var cache = [],
      cardNoArr = cardNo.split(''),
      temp = void 0,
      cardNoTemp = void 0,
      cardNoArrLen = cardNoArr.length,
      sum = 0,
      cacheLen = void 0;
  /*信用卡校验规则：
   *1、从倒数第二位开始，每相隔一位*2，如果乘积为两位数则数字相加
   *2、得到的乘积与1中未处理的数字相加（除了最后一位），取和向上最近的以0结尾的数字
   *3、用2得到的数字减去2中相加的和，得到的数字等于信用卡最后一位
   */
  if (cardNoArrLen < 1) {
    return false;
  }
  var lastnumber = cardNoArr[cardNoArrLen - 1];
  var cacuIndex = cardNoArrLen - 2;
  var curIndex = cardNoArrLen - 1;
  while (curIndex--) {
    var mod = cacuIndex - curIndex;
    if (mod % 2) {
      cache.push(parseInt(cardNoArr[curIndex]));
    } else {
      cardNoTemp = cardNoArr[curIndex] * 2;

      if (cardNoTemp.toString().length == 1) {
        cache.push(cardNoArr[curIndex] * 2);
      } else {
        temp = cardNoTemp.toString().split('');
        cache.push(parseInt(temp[0], 10) + parseInt(temp[1], 10));
      }
    }
  }
  cacheLen = cache.length;
  while (cacheLen--) {
    sum += cache[cacheLen];
  }
  var ceil = Math.ceil(sum / 10);
  return ceil * 10 - sum == lastnumber;
};

submit.addEventListener('click', function () {
  if (ipt.value.length >= 13 && ipt.value.length <= 24 && test(ipt.value)) {
    http.post('/merchantInfo/queryBank', { bankNo: ipt.value }, function (data) {
      if (data != 1) {
        message.prompt_show('请输入正确的信用卡号');
      } else {
        http.post('/wx/creditCardAuthen', {
          creditCard: ipt.value
        }, function () {
          if (getQueryString('card')) {
            layer.style.display = 'block';
          } else {
            window.location.href = '/sqb/authentication';
          }
        });
      }
    });
  } else {
    message.prompt_show('请输入正确的信用卡号');
  }
});
//# sourceMappingURL=creditCardAuthen.min.js.map
