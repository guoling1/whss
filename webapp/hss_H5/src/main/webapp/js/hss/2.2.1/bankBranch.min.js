'use strict';

/**
 * Created by administrator on 2016/12/8.
 */

// 引入浏览器特性处理
var http = _require('http');
var message = _require('message');
var validate = _require('validate');
var browser = _require('browser');
browser.elastic_touch('layer-w-list');
browser.elastic_touch('layer-b-list');
// 定义变量
var color = document.getElementById('color');
var logo = document.getElementById('logo');
// 获取屏幕高度 确定搜索栏位置
var client_h = document.body.clientHeight;
var layer_w = document.getElementById('layer-w');
var layer_w_list = document.getElementById('layer-w-list');
var layer_b = document.getElementById('layer-b');
var layer_b_list = document.getElementById('layer-b-list');
// 定义输入框
var submit = document.getElementById('submit');
var world = document.getElementById('world');
var branch = document.getElementById('branch');
var match_ipt = document.getElementById('match_ipt');
// 定义选择框
var p = document.getElementById('p');
var c = document.getElementById('c');
var ct = document.getElementById('ct');

var Provinces = false;
var Citys = false;
var Countrys = false;

function getQueryString(name) {
  var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
  var r = window.location.search.substr(1).match(reg);
  if (r != null) return unescape(r[2]);
  return null;
}

function getLocationString() {
  var path = window.location.href;
  var index = path.lastIndexOf("\/");
  return path.substring(index + 1, path.length);
}

// 处理 初始化 的过程
if (pageData.provinceCode != '' && pageData.provinceName != '' && pageData.cityCode != '' && pageData.cityName != '' && pageData.countyCode != '' && pageData.countyName != '' && pageData.branchCode != '' && pageData.branchName != '') {
  world.value = pageData.provinceName + pageData.cityName + pageData.countyName;
  branch.value = pageData.branchName;
}

submit.onclick = function () {
  if (validate.empty(pageData.provinceCode, '所在地区') && validate.empty(pageData.provinceName, '所在地区') && validate.empty(pageData.cityCode, '所在地区') && validate.empty(pageData.cityName, '所在地区') && validate.empty(pageData.countyCode, '所在地区') && validate.empty(pageData.countyName, '所在地区') && validate.empty(pageData.branchCode, '支行信息') && validate.empty(pageData.branchName, '支行信息')) {
    http.post('/wx/branchInfo', {
      bankId: getLocationString(),
      branchCode: pageData.branchCode,
      branchName: pageData.branchName,
      provinceCode: pageData.provinceCode,
      provinceName: pageData.provinceName,
      cityCode: pageData.cityCode,
      cityName: pageData.cityName,
      countyCode: pageData.countyCode,
      countyName: pageData.countyName
    }, function () {
      if (getQueryString('card')) {
        window.location.href = '/sqb/creditCardAuthen?card=true';
      } else if (getQueryString('branch')) {
        layer.style.display = 'block';
      } else {
        window.location.href = '/sqb/bank';
      }
    });
  }
};

branch.onclick = function () {
  if (!pageData.countyName || pageData.countyName == '') {
    message.prompt_show('请先选择支行地区');
    return false;
  }
  layer_b.style.display = 'block';
  var rect_b = layer_b.getBoundingClientRect();
  layer_b.style.height = client_h - rect_b.top + 'px';
  layer_b_list.style.height = client_h - rect_b.top - 50 + 'px';
  match_ipt.focus();
};

match_ipt.addEventListener('input', function (e) {
  var ev = e.target;
  if (/[\u4e00-\u9fa5]{2,50}/.test(ev.value)) {
    http.post('/bankBranch/getBankBranch', {
      contions: ev.value,
      provinceName: pageData.provinceName,
      cityName: pageData.cityName
    }, function (data) {
      layer_b_list.innerHTML = '';
      console.log(data);

      var _loop = function _loop(i) {
        var div_branch = document.createElement('div');
        div_branch.className = 't';
        div_branch.innerHTML = data[i].branchName;
        div_branch.onclick = function () {
          branch.value = data[i].branchName;
          pageData.branchCode = data[i].branchCode;
          pageData.branchName = data[i].branchName;
          layer_b.style.display = 'none';
        };
        layer_b_list.appendChild(div_branch);
      };

      for (var i = 0; i < data.length; i++) {
        _loop(i);
      }
    });
  }
});

world.onclick = function () {
  layer_b.style.display = 'none';
  if (!Provinces) {
    // 如果不存在 则去获取数据
    http.post('/district/findAllProvinces', {}, function (data) {
      Provinces = data;
      ProvincesSet();
    });
  } else {
    ProvincesSet();
  }
  branch.value = '';
  layer_b_list.innerHTML = '';
  layer_w.style.display = 'block';
  var rect_w = layer_w.getBoundingClientRect();
  layer_w.style.height = client_h - rect_w.top + 'px';
  layer_w_list.style.height = client_h - rect_w.top - 100 + 'px';
};

// Provinces 部署事件
var ProvincesSet = function ProvincesSet() {
  layer_w_list.innerHTML = '';

  var _loop2 = function _loop2(i) {
    var div_Provinces = document.createElement('div');
    div_Provinces.innerHTML = Provinces[i].aname;
    div_Provinces.onclick = function () {
      p.className = '';
      p.innerHTML = Provinces[i].aname;
      pageData.provinceCode = Provinces[i].code;
      pageData.provinceName = Provinces[i].aname;
      if (!Citys || !Citys[Provinces[i].code]) {
        http.post('/district/findAllCity', { code: Provinces[i].code }, function (data) {
          Citys = {};
          Citys[Provinces[i].code] = data;
          CitysSet(Provinces[i].code);
        });
      } else {
        CitysSet(Provinces[i].code);
      }
    };
    layer_w_list.appendChild(div_Provinces);
  };

  for (var i = 0; i < Provinces.length; i++) {
    _loop2(i);
  }
  p.className = 'choose';
  p.style.display = 'inline-block';
};

// Citys 部署事件
var CitysSet = function CitysSet(code) {
  layer_w_list.innerHTML = '';

  var _loop3 = function _loop3(i) {
    var div_Citys = document.createElement('div');
    div_Citys.innerHTML = Citys[code][i].aname;
    div_Citys.onclick = function () {
      c.className = '';
      c.innerHTML = Citys[code][i].aname;
      pageData.cityCode = Citys[code][i].code;
      pageData.cityName = Citys[code][i].aname;
      if (!Countrys || !Countrys[Citys[code][i].code]) {
        http.post('/district/findAllCounty', { code: Citys[code][i].code }, function (data) {
          Countrys = {};
          Countrys[Citys[code][i].code] = data;
          CountrysSet(Citys[code][i].code);
        });
      } else {
        CountrysSet(Citys[code][i].code);
      }
    };
    layer_w_list.appendChild(div_Citys);
  };

  for (var i = 0; i < Citys[code].length; i++) {
    _loop3(i);
  }
  c.className = 'choose';
  c.style.display = 'inline-block';
};

// Countrys 部署事件
var CountrysSet = function CountrysSet(code) {
  layer_w_list.innerHTML = '';

  var _loop4 = function _loop4(i) {
    var div_Countrys = document.createElement('div');
    div_Countrys.innerHTML = Countrys[code][i].aname;
    div_Countrys.onclick = function () {
      ct.className = '';
      ct.innerHTML = Countrys[code][i].aname;
      pageData.countyCode = Countrys[code][i].code;
      pageData.countyName = Countrys[code][i].aname;
      world.value = pageData.provinceName + pageData.cityName + pageData.countyName;
      layer_w.style.display = 'none';
    };
    layer_w_list.appendChild(div_Countrys);
  };

  for (var i = 0; i < Countrys[code].length; i++) {
    _loop4(i);
  }
  ct.className = 'choose';
  ct.style.display = 'inline-block';
};

p.onclick = function () {
  c.style.display = 'none';
  ct.style.display = 'none';
  ProvincesSet();
};

c.onclick = function () {
  ct.style.display = 'none';
  CitysSet(pageData.provinceCode);
};

ct.onclick = function () {
  CitysSet(pageData.cityCode);
};

// 卡bin和颜色一一对应
var bankCardBin = ['ABC', 'BANKCOMM', 'BOC', 'CCB', 'CEB', 'CGB', 'CIB', 'CITIC', 'CMB', 'CMBC', 'ICBC', 'PINGAN', 'PSBC', 'SHBANK'];
var bankLogoColor = ['green', 'blue', 'red', 'blue', 'red', 'red', 'blue', 'red', 'red', 'red', 'red', 'red', 'green', 'red'];

var HasBank = function HasBank() {
  for (var i = 0; i < bankCardBin.length; i++) {
    if (bankCardBin[i] == pageData.bin) {
      return i;
    }
  }
  return -1;
};

var index = HasBank();

if (index != -1) {
  color.className = 'group ' + bankLogoColor[index];
  logo.className = 'logo ' + pageData.bin;
} else {
  color.className = 'group red';
  logo.className = 'logo DEFAULT';
}
//# sourceMappingURL=bankBranch.min.js.map
