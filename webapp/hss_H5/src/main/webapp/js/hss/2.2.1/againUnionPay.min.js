'use strict';

/**
 * Created by administrator on 2016/12/6.
 */

// 引入浏览器特性处理
var browser = _require('browser');
browser.elastic_touch();
// 引入动画模版 处理验证码
var AnimationCountdown = _require('art-countdown');
var countdown = new AnimationCountdown('sendCode', '重新获取');
// 引入http message
var http = _require('http');
var validate = _require('validate');
var message = _require('message');

function getQueryString(name) {
  var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
  var r = window.location.search.substr(1).match(reg);
  if (r != null) return unescape(r[2]);
  return null;
}

// 定义变量
var layer = document.getElementById('layer');
var layer_body = document.getElementById('layer-body');
var layer_x = document.getElementById('layer-x');
var chooseBank = document.getElementById('chooseBank');
var sendCode = document.getElementById('sendCode');
var submit = document.getElementById('submit');
var addNew = document.getElementById('addNew');

var check_cvv = document.getElementById('check_cvv');
var example_cvv = document.getElementById('example_cvv');
var cancel_cvv = document.getElementById('cancel_cvv');

check_cvv.addEventListener('click', function () {
  example_cvv.style.display = 'block';
});

cancel_cvv.addEventListener('click', function () {
  example_cvv.style.display = 'none';
});

var amount = getQueryString('amount');
var channel = getQueryString('channel');
var cvv2 = document.getElementById('cvv2');
var code = document.getElementById('code');
var orderId = '';
// 选择支付卡
chooseBank.addEventListener('click', function () {
  layer.style.display = 'block';
});
// 定义添加新卡
addNew.addEventListener('click', function () {
  window.location.replace('/trade/firstUnionPayPage?amount=' + amount + '&channel=' + channel);
});
// 定义支付
submit.addEventListener('click', function () {
  http.post('/trade/confirmUnionPay', {
    orderId: orderId,
    code: code.value
  }, function () {
    window.location.replace('/trade/unionPaySuccess/' + orderId);
  });
});
// 定义验证码
sendCode.addEventListener('click', function () {
  if (countdown.check()) {
    http.post('/trade/againUnionPay', {
      amount: amount,
      channel: channel,
      creditCardId: pageData.creditCardId,
      cvv2: cvv2.value
    }, function (data) {
      orderId = data.orderId;
      message.prompt_show('验证码发送成功');
      countdown.submit_start();
    });
  }
});

// 获取支持的银行卡列表
http.post('/bankcard/list/' + pageData.creditCardId, {}, function (data) {
  var _loop = function _loop(i) {
    var list = document.createElement('div');
    if (pageData.creditCardId == data[i].creditCardId) {
      list.className = 'choose-box-body-list-bank active';
    } else {
      list.className = 'choose-box-body-list-bank';
    }
    list.addEventListener('click', function () {
      var className = document.getElementsByClassName('choose-box-body-list-bank');
      for (var _i = 0; _i < className.length; _i++) {
        className[_i].className = 'choose-box-body-list-bank';
      }
      this.className = 'choose-box-body-list-bank active';
      pageData.creditCardId = data[i].creditCardId;
      layer.style.display = 'none';
    });
    var logo = document.createElement('div');
    logo.className = 'logo';
    var info = document.createElement('div');
    info.className = 'info';
    info.innerHTML = data[i].bankName + ' (' + data[i].shortNo + ')' + ' <span>信用卡</span>';
    list.appendChild(logo);
    list.appendChild(info);
    layer_body.appendChild(list);
  };

  for (var i = 0; i < data.length; i++) {
    _loop(i);
  }
});
//# sourceMappingURL=againUnionPay.min.js.map
