'use strict';

/**
 * Created by administrator on 2016/12/6.
 */

// 引入浏览器特性处理
var browser = _require('browser');
browser.elastic_touch();
// 引入动画模版 处理验证码
var AnimationCountdown = _require('art-countdown');
var countdown = new AnimationCountdown('sendCode', '重新获取');
// 时间选择器
var DatePicker = _require('datePicker');
new DatePicker('expireDate');
// 引入http message
var http = _require('http');
var validate = _require('validate');
var message = _require('message');

function fmoney(s, n) {
  n = n > 0 && n <= 20 ? n : 2;
  s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";
  var l = s.split(".")[0].split("").reverse(),
      r = s.split(".")[1];
  var t = "";
  for (var i = 0; i < l.length; i++) {
    t += l[i] + ((i + 1) % 3 == 0 && i + 1 != l.length ? "," : "");
  }
  return t.split("").reverse().join("") + "." + r;
}

function getQueryString(name) {
  var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
  var r = window.location.search.substr(1).match(reg);
  if (r != null) return unescape(r[2]);
  return null;
}

// 定义变量
var chooseBank = document.getElementById('chooseBank');
var sendCode = document.getElementById('sendCode');
var submit = document.getElementById('submit');

var check_cvv = document.getElementById('check_cvv');
var example_cvv = document.getElementById('example_cvv');
var cancel_cvv = document.getElementById('cancel_cvv');

check_cvv.addEventListener('click', function () {
  example_cvv.style.display = 'block';
});

cancel_cvv.addEventListener('click', function () {
  example_cvv.style.display = 'none';
});

var check_validity = document.getElementById('check_validity');
var example_validity = document.getElementById('example_validity');
var cancel_validity = document.getElementById('cancel_validity');

check_validity.addEventListener('click', function () {
  example_validity.style.display = 'block';
});

cancel_validity.addEventListener('click', function () {
  example_validity.style.display = 'none';
});

var layer_channel = document.getElementById('layer-channel');
var know_channel = document.getElementById('know_channel');
var layer_x_channel = document.getElementById('layer-x-channel');
var submit_channel = document.getElementById('submit-channel');

know_channel.addEventListener('click', function () {
  layer_channel.style.display = 'block';
});

layer_x_channel.addEventListener('click', function () {
  layer_channel.style.display = 'none';
});

submit_channel.addEventListener('click', function () {
  layer_channel.style.display = 'none';
});

// 定义信用卡号 正确性校验
var test = function test(cardNo) {
  cardNo = cardNo || '';
  var cache = [],
      cardNoArr = cardNo.split(''),
      temp = void 0,
      cardNoTemp = void 0,
      cardNoArrLen = cardNoArr.length,
      sum = 0,
      cacheLen = void 0;
  /*信用卡校验规则：
   *1、从倒数第二位开始，每相隔一位*2，如果乘积为两位数则数字相加
   *2、得到的乘积与1中未处理的数字相加（除了最后一位），取和向上最近的以0结尾的数字
   *3、用2得到的数字减去2中相加的和，得到的数字等于信用卡最后一位
   */
  if (cardNoArrLen < 1) {
    return false;
  }
  var lastnumber = cardNoArr[cardNoArrLen - 1];
  var cacuIndex = cardNoArrLen - 2;
  var curIndex = cardNoArrLen - 1;
  while (curIndex--) {
    var mod = cacuIndex - curIndex;
    if (mod % 2) {
      cache.push(parseInt(cardNoArr[curIndex]));
    } else {
      cardNoTemp = cardNoArr[curIndex] * 2;

      if (cardNoTemp.toString().length == 1) {
        cache.push(cardNoArr[curIndex] * 2);
      } else {
        temp = cardNoTemp.toString().split('');
        cache.push(parseInt(temp[0], 10) + parseInt(temp[1], 10));
      }
    }
  }
  cacheLen = cache.length;
  while (cacheLen--) {
    sum += cache[cacheLen];
  }
  var ceil = Math.ceil(sum / 10);
  return ceil * 10 - sum == lastnumber;
};

var amount = getQueryString('amount');
var channel = getQueryString('channel');
var bankName = '';
var bankCode = '';
var bankCodeBtn = document.getElementById('bankCode');
var expireDate = document.getElementById('expireDate');
var cvv2 = document.getElementById('cvv2');
var mobile = document.getElementById('mobile');
var code = document.getElementById('code');
var orderId = '';
var supportBankCardList = {};
var support = false;
// 是否展示 有效期选择 cvv2填写
var showExpireDate = document.getElementById('showExpireDate');
var showCvv = document.getElementById('showCvv');
if (pageData.showExpireDate == 1) {
  showExpireDate.style.display = 'block';
}
if (pageData.showCvv == 1) {
  showCvv.style.display = 'block';
}
// 定义变量
var magnifying = document.getElementById('magnifying');
var del = document.getElementById('del');
del.addEventListener('click', function () {
  bankCodeBtn.value = '';
  del.style.display = 'none';
});
// 定义信用卡号校验
bankCodeBtn.addEventListener('click', function () {
  if (!bankName || bankName == '') {
    message.prompt_show('请先选择所属银行');
  }
});
bankCodeBtn.addEventListener('focus', function (e) {
  var ev = e.target;
  // 判断是否展示 清空按钮
  if (ev.value) {
    del.style.display = 'block';
  } else {
    del.style.display = 'none';
  }
});
bankCodeBtn.addEventListener('blur', function (e) {
  magnifying.style.display = 'none';
});
bankCodeBtn.addEventListener('input', function (e) {
  var ev = e.target;
  // 判断是否展示 清空按钮
  if (ev.value) {
    del.style.display = 'block';
  } else {
    del.style.display = 'none';
  }
  // 判断是否需要展示放大镜
  magnifying.innerHTML = ev.value.replace(/\s/g, '').replace(/(.{4})/g, "$1 ");
  if (ev.value.length >= 1) {
    magnifying.style.display = 'block';
  } else {
    magnifying.style.display = 'none';
  }
});
bankCodeBtn.addEventListener('change', function (e) {
  var ev = e.target;
  if (ev.value.length >= 13 && ev.value.length <= 24 && test(ev.value)) {
    http.post('/merchantInfo/selectBankNameByBankNo', {
      bankNo: ev.value
    }, function (data) {
      if (!data || data == '') {
        support = false;
        message.prompt_show('暂不支持使用储蓄卡');
      } else {
        var allow = false;
        for (var i = 0; i < supportBankCardList.length; i++) {
          if (data == supportBankCardList[i].bankCode && supportBankCardList[i].status == 1) {
            allow = true;
            support = true;
            if (supportBankCardList[i].bankName != bankName) {
              bankName = supportBankCardList[i].bankName;
              bankCode = supportBankCardList[i].bankCode;
              chooseBank.innerHTML = supportBankCardList[i].bankName;
              chooseBank.className = 'adaptive text active';
            }
          }
        }
        if (!allow) {
          support = false;
          message.prompt_show('暂时不支持该银行的卡');
        }
      }
    });
  }
});
// 定义支付
submit.addEventListener('click', function () {
  if (!support) {
    message.prompt_show('请输入正确的信用卡号');
  } else if ((pageData.showExpireDate == 0 || validate.empty(expireDate.innerHTML, '信用卡有效期')) && (pageData.showCvv == 0 || validate.empty(cvv2.value, 'CVV2')) && validate.phone(mobile.value) && validate.empty(code.value, '验证码')) {
    if (pageData.showCvv == 0 || cvv2.value.length == 3) {
      message.load_show('正在支付');
      http.post('/trade/confirmUnionPay', {
        orderId: orderId,
        code: code.value
      }, function () {
        message.load_hide();
        window.location.replace('/trade/unionPaySuccess/' + orderId);
      });
    } else {
      message.prompt_show('请输入正确的CVV2');
    }
  }
});
// 定义验证码
sendCode.addEventListener('click', function () {
  if (countdown.check()) {
    if (!support) {
      message.prompt_show('请输入正确的信用卡号');
    } else if ((pageData.showExpireDate == 0 || validate.empty(expireDate.innerHTML, '信用卡有效期')) && (pageData.showCvv == 0 || validate.empty(cvv2.value, 'CVV2')) && validate.phone(mobile.value)) {
      if (pageData.showCvv == 0 || cvv2.value.length == 3) {
        message.load_show('正在发送');
        var expire = expireDate.innerHTML.split('/');
        http.post('/trade/firstUnionPay', {
          amount: amount,
          channel: channel,
          bankCode: bankCode,
          bankCardNo: bankCodeBtn.value,
          expireDate: expire[1] + expire[0],
          cvv2: cvv2.value,
          mobile: mobile.value
        }, function (data) {
          orderId = data.orderId;
          message.load_hide();
          message.prompt_show('验证码发送成功');
          countdown.submit_start();
        });
      } else {
        message.prompt_show('请输入正确的CVV2');
      }
    }
  }
});

// 获取支持的银行卡列表
var bankNameList = [];
http.post('/channel/queryChannelSupportBank', {
  channelSign: channel
}, function (data) {
  supportBankCardList = data;
  for (var i = 0; i < data.length; i++) {
    var bankNameObject = {};
    bankNameObject.label = '<span style="color: #5a5a5a">' + data[i].bankName + '</span><span style="font-size: 14px;color: #5a5a5a"> (单笔限额' + fmoney(data[i].singleLimitAmount, 2) + '元)</span>';
    bankNameObject.value = data[i].bankName + '/' + data[i].bankCode;
    if (data[i].status == 1) {
      bankNameList.push(bankNameObject);
    }
  }
  chooseBank.addEventListener('click', function () {
    weui.picker(bankNameList, {
      onConfirm: function onConfirm(result) {
        var format = result[0].split('/');
        chooseBank.innerHTML = format[0];
        chooseBank.className = 'adaptive text active';
        bankName = format[0];
        bankCode = format[1];
        bankCodeBtn.removeAttribute('readonly');
      },
      id: 'chooseBank'
    });
  });
});
//# sourceMappingURL=firstUnionPay.min.js.map
